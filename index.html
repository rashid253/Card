<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.wrap{max-width:480px;margin:auto;padding:16px}
h2{margin-top:20px}

input,textarea,select{
 width:100%;
 padding:12px;
 margin:6px 0;
 border-radius:10px;
 border:1px solid #cbd5f5;
 box-sizing:border-box;
}
button{
 width:100%;
 padding:16px;
 border:none;
 border-radius:12px;
 background:#2563eb;
 color:white;
 font-size:17px;
 margin-top:20px;
 cursor:pointer;
}

.offerBox{
 background:#fff;
 padding:12px;
 border-radius:12px;
 margin-top:12px;
 border:1px solid #e2e8f0;
}

.badgeGrid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin-top:10px;
 font-size:14px;
}
.badgeGrid label{
 display:flex;
 gap:8px;
 align-items:center;
}

.dayBox{
 background:#fff;
 padding:10px;
 border-radius:10px;
 margin-bottom:8px;
 display:grid;
 grid-template-columns:28px 1fr;
 gap:8px;
 align-items:center;
 border:1px solid #e2e8f0;
}
.dayCheck{display:flex;justify-content:center}
.dayContent{display:flex;flex-direction:column;gap:6px}
.dayRow{display:flex;align-items:center;gap:8px}
.dayRow label{font-weight:500}
</style>

<script>
// Redirect if PWA and has saved card
if ((window.matchMedia('(display-mode: standalone)').matches || navigator.standalone)){
 const last=localStorage.getItem("lastCardId");
 if(last) location.replace("card.html?id="+last);
}
</script>
</head>

<body>
<div class="wrap">

<h2>Profile</h2>
<input type="file" id="profileImage" accept="image/*">
<input id="fullName" placeholder="Full Name">
<input id="phoneNumber" placeholder="Phone" type="tel">
<input id="email" placeholder="Email" type="email">
<input id="address" placeholder="Address">

<h2>Business</h2>
<input id="businessName" placeholder="Business Title">
<textarea id="businessAbout" placeholder="About your business" rows="4"></textarea>

<h3>Business Hours</h3>
<div id="daysContainer"></div>

<h2>Offers</h2>
<div id="offersForm"></div>
<button type="button" onclick="addOffer()">âž• Add Offer</button>

<button type="button" onclick="generate()">Generate Card</button>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// Initialize business hours
const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
days.forEach(d => {
 const dayBox = document.createElement("div");
 dayBox.className = "dayBox";
 dayBox.innerHTML = `
  <div class="dayCheck">
   <input type="checkbox" checked class="dayOpen">
  </div>
  <div class="dayContent">
   <div class="dayRow"><label>${d}</label></div>
   <div class="dayRow">
    <input type="time" class="dayStart" value="09:00">
    <span>to</span>
    <input type="time" class="dayEnd" value="17:00">
   </div>
  </div>
 `;
 daysContainer.appendChild(dayBox);
});

// Offer management
let offerCount = 0;
function addOffer(){
 offerCount++;
 const box = document.createElement("div");
 box.className = "offerBox";
 box.innerHTML = `
  <h3>Offer ${offerCount}</h3>
  <input type="file" class="offerImg" accept="image/*">
  <input class="offerTitle" placeholder="Title (e.g., 20% Off)">
  <textarea class="offerDesc" placeholder="Description (e.g., Valid until Dec 31)" rows="3"></textarea>
  
  <div class="badgeGrid">
   <label><input type="checkbox" value="ðŸ”¥ Hot Deal"> Hot Deal</label>
   <label><input type="checkbox" value="â­ Best Seller"> Best Seller</label>
   <label><input type="checkbox" value="ðŸ’¸ Discount"> Discount</label>
   <label><input type="checkbox" value="â³ Limited Time"> Limited Time</label>
   <label><input type="checkbox" value="ðŸšš Free Delivery"> Free Delivery</label>
   <label><input type="checkbox" value="ðŸ· Special Price"> Special Price</label>
  </div>
 `;
 offersForm.appendChild(box);
}

// Image compression
function resizeImage(file){
 return new Promise(res => {
  const img = new Image();
  img.onload = () => {
   const canvas = document.createElement("canvas");
   const max = 1024;
   const ratio = Math.min(max/img.width, max/img.height, 1);
   canvas.width = img.width * ratio;
   canvas.height = img.height * ratio;
   const ctx = canvas.getContext("2d");
   ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
   res(canvas.toDataURL("image/jpeg", 0.85));
  };
  img.src = URL.createObjectURL(file);
 });
}

// Generate card
async function generate(){
 if(!fullName.value || !phoneNumber.value){
  alert("Name & Phone number are required");
  return;
 }

 const id = crypto.randomUUID();

 // Collect business hours
 const businessHoursArray = [];
 const dayBoxes = document.querySelectorAll(".dayBox");
 dayBoxes.forEach(box => {
  const open = box.querySelector(".dayOpen").checked;
  const start = box.querySelector(".dayStart").value;
  const end = box.querySelector(".dayEnd").value;
  
  businessHoursArray.push({
   open: open,
   start: open ? start : null,
   end: open ? end : null
  });
 });

 // Collect offers
 const offersArray = [];
 const offerBoxes = document.querySelectorAll(".offerBox");
 
 for(let i = 0; i < offerBoxes.length; i++){
  const box = offerBoxes[i];
  const title = box.querySelector(".offerTitle").value;
  const desc = box.querySelector(".offerDesc").value;
  const file = box.querySelector(".offerImg").files[0];
  
  if(title || desc || file){
   const badges = Array.from(box.querySelectorAll("input[type=checkbox]:checked"))
    .map(cb => cb.value);
   
   const offerData = {
    title: title || "",
    desc: desc || "",
    badges: badges,
    image: ""
   };
   
   if(file){
    offerData.image = await resizeImage(file);
   }
   
   offersArray.push(offerData);
  }
 }

 // Prepare data
 const cardData = {
  name: fullName.value.trim(),
  phone: phoneNumber.value.trim(),
  email: email.value.trim(),
  address: address.value.trim(),
  businessName: businessName.value.trim(),
  business: {
   about: businessAbout.value.trim()
  },
  businessHours: businessHoursArray,
  offers: offersArray
 };

 // Add profile image if exists
 if(profileImage.files[0]){
  cardData.profileImage = await resizeImage(profileImage.files[0]);
 }

 // Save to Supabase
 const { data: inserted, error } = await db.from("cards").insert({
   id: id,
   data: JSON.stringify(cardData)
 }).select().single();

 if(error){
   console.error("Supabase error:", error);
   alert("Failed to save card: " + error.message);
   return;
 }

 // Store ID and redirect
 localStorage.setItem("lastCardId", inserted.id);
 location.href = "card.html?id=" + inserted.id;
}
</script>
</body>
</html>
