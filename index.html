<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.wrap{max-width:480px;margin:auto;padding:16px}
h2{margin-top:20px}

input,textarea{
 width:100%;
 padding:12px;
 margin:6px 0;
 border-radius:10px;
 border:1px solid #cbd5f5
}
button{
 width:100%;
 padding:16px;
 border:none;
 border-radius:12px;
 background:#2563eb;
 color:white;
 font-size:17px;
 margin-top:20px
}
.offerBox{
 background:white;
 padding:12px;
 border-radius:12px;
 margin-top:12px
}

/* BADGES â€“ 2 COLUMN SIMPLE TEXT */
.badgeGrid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin-top:10px;
 font-size:14px;
}
.badgeGrid label{
 display:flex;
 gap:8px;
 align-items:center;
}

/* BUSINESS HOURS */
.dayBox{
 background:#fff;
 padding:10px;
 border-radius:10px;
 margin-bottom:8px;
 display:grid;
 grid-template-columns:28px 1fr;
 gap:8px;
 align-items:center
}
.dayCheck{display:flex;justify-content:center}
.dayContent{display:flex;flex-direction:column;gap:6px}
.dayRow{display:flex;align-items:center;gap:8px}
.dayRow label{font-weight:500}
.small{font-size:13px;color:#475569}
</style>

<script>
if ((window.matchMedia('(display-mode: standalone)').matches || navigator.standalone)){
 const last=localStorage.getItem("lastCardId");
 if(last) location.replace("card.html?id="+last);
}
</script>
</head>

<body>
<div class="wrap">

<h2>Profile</h2>
<input type="file" id="profileImage">
<input id="fullName" placeholder="Full Name">
<input id="phoneNumber" placeholder="Phone">
<input id="email" placeholder="Email">
<input id="address" placeholder="Address">

<h2>Business</h2>
<input id="businessName" placeholder="Business Title">
<textarea id="businessAbout" placeholder="About your business"></textarea>

<h3>Business Hours</h3>
<div id="daysContainer"></div>

<h2>Offers</h2>
<div id="offersForm"></div>
<button onclick="addOffer()">âž• Add Offer</button>

<button onclick="generate()">Generate Card</button>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const db=supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

/* BUSINESS DAYS */
["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"]
.forEach(d=>{
 daysContainer.innerHTML+=`
 <div class="dayBox">
  <div class="dayCheck"><input type="checkbox" checked></div>
  <div class="dayContent">
   <div class="dayRow"><label>${d}</label></div>
   <div class="dayRow">
    <input type="time">
    <input type="time">
   </div>
  </div>
 </div>`;
});

/* OFFERS */
let offerCount=0;
function addOffer(){
 offerCount++;
 const box=document.createElement("div");
 box.className="offerBox";
 box.dataset.index=offerCount;

 box.innerHTML=`
  <b>Offer ${offerCount}</b>
  <input type="file" class="offerImg">
  <input class="offerTitle" placeholder="Title">
  <textarea class="offerDesc" placeholder="Description"></textarea>

  <div class="badgeGrid">
   <label><input type="checkbox" value="ðŸ”¥ Hot Deal"> Hot Deal</label>
   <label><input type="checkbox" value="â­ Best Seller"> Best Seller</label>
   <label><input type="checkbox" value="ðŸ’¸ Discount"> Discount</label>
   <label><input type="checkbox" value="â³ Limited Time"> Limited Time</label>
   <label><input type="checkbox" value="ðŸšš Free Delivery"> Free Delivery</label>
   <label><input type="checkbox" value="ðŸ· Special Price"> Special Price</label>
  </div>
 `;
 offersForm.appendChild(box);
}

/* IMAGE COMPRESS */
function resizeImage(file){
 return new Promise(res=>{
  const img=new Image();
  img.onload=()=>{
   const c=document.createElement("canvas");
   const max=1024;
   const r=Math.min(max/img.width,max/img.height,1);
   c.width=img.width*r;
   c.height=img.height*r;
   c.getContext("2d").drawImage(img,0,0,c.width,c.height);
   res(c.toDataURL("image/jpeg",0.85));
  };
  img.src=URL.createObjectURL(file);
 });
}

/* GENERATE */
async function generate(){
 if(!fullName.value||!phoneNumber.value){
  alert("Name & Phone required");return;
 }

 const id=Math.random().toString(36).slice(2,8);
 const offers=[];

 document.querySelectorAll(".offerBox").forEach(async box=>{
  const t=box.querySelector(".offerTitle").value;
  const d=box.querySelector(".offerDesc").value;
  const f=box.querySelector(".offerImg").files[0];
  if(t&&d){
   const badges=[...box.querySelectorAll("input[type=checkbox]:checked")]
    .map(b=>b.value);
   offers.push({
    title:t,
    desc:d,
    badges:badges,
    image:f?await resizeImage(f):""
   });
  }
 });

 const data={
  name:fullName.value,
  phone:phoneNumber.value,
  email:email.value,
  address:address.value,
  businessName:businessName.value,
  business:{about:businessAbout.value},
  offers:offers
 };

 if(profileImage.files[0])
  data.profileImage=await resizeImage(profileImage.files[0]);

 await db.from("cards").insert({id,data:JSON.stringify(data)});
 localStorage.setItem("lastCardId",id);
 location.href="card.html?id="+id;
}
</script>
</body>
</html>
