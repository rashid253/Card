<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Faisalabad Business Directory</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.header{background:#0f172a;color:white;padding:14px;text-align:center}
.list{max-width:480px;margin:auto;padding:12px}
.item{
 background:white;border-radius:14px;padding:12px;
 display:flex;gap:12px;align-items:center;
 margin-bottom:10px;cursor:pointer;
 box-shadow:0 4px 10px rgba(0,0,0,.1)
}
.item img{
 width:60px;height:60px;border-radius:50%;
 object-fit:cover;background:#e2e8f0
}
.name{font-weight:700}
.addr{font-size:12px;color:#475569}
.add{
 position:fixed;right:16px;bottom:16px;
 width:56px;height:56px;border-radius:50%;
 background:#2563eb;color:white;
 display:flex;align-items:center;justify-content:center;
 font-size:28px
}
#status{
 text-align:center;
 padding:28px 22px;
 color:#475569;
 line-height:1.7;
 font-size:14px;
}
</style>
</head>

<body>

<div class="header">
<h2>Faisalabad Business Directory</h2>
<p style="font-size:13px">Local businesses, one place</p>
</div>

<div id="status">
ğŸŒ± Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯  
<br>
ÙÛŒØ³Ù„ Ø¢Ø¨Ø§Ø¯ Ú©Û’ Ú©Ø§Ø±ÙˆØ¨Ø§Ø± Ø§ÛŒÚ© Ø¬Ú¯Û Ø¬Ù…Ø¹ Ú©ÛŒÛ’ Ø¬Ø§ Ø±ÛÛ’ ÛÛŒÚºâ€¦
</div>

<div id="list" class="list"></div>

<div class="add" onclick="location.href='create.html'">+</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
if('serviceWorker' in navigator){
 navigator.serviceWorker.register("sw.js");
}

const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

const list = document.getElementById("list");
const statusBox = document.getElementById("status");

/* --------- RENDER --------- */
function render(data){
 list.innerHTML="";
 data.forEach(row=>{
  const d = JSON.parse(row.data);
  const div = document.createElement("div");
  div.className="item";
  div.onclick=()=>location.href="card.html?id="+row.id;
  div.innerHTML=`
   <img src="${d.profileImage||''}">
   <div>
    <div class="name">${d.businessName||'Business'}</div>
    <div class="addr">${d.address||'Faisalabad'}</div>
   </div>`;
  list.appendChild(div);
 });
}

/* --------- STEP 1: INSTANT CACHE LOAD --------- */
let cacheUsed = false;
const cached = localStorage.getItem("fsd_cards");

if(cached){
 cacheUsed = true;
 statusBox.style.display="none";
 render(JSON.parse(cached));
}

/* --------- STEP 2: BACKGROUND WAKE --------- */
db.from("cards").select("id").limit(1);

/* --------- STEP 3: BACKGROUND FETCH --------- */
(async ()=>{
 const {data, error} = await db
  .from("cards")
  .select("*")
  .order("id",{ascending:false});

 if(error || !data) return;

 const newData = JSON.stringify(data);
 const oldData = localStorage.getItem("fsd_cards");

 // FIRST SUCCESS EVER â†’ save permanently
 if(!oldData){
  localStorage.setItem("fsd_cards", newData);
  statusBox.style.display="none";
  render(data);
  return;
 }

 // SILENT UPDATE (no flicker)
 if(oldData !== newData){
  localStorage.setItem("fsd_cards", newData);
  if(cacheUsed) render(data);
 }
})();
</script>
</body>
</html>
