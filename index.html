<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.wrap{max-width:480px;margin:auto;padding:16px}
h2{margin-top:20px;margin-bottom:10px}

input,textarea,select{
 width:100%;
 padding:12px;
 margin:6px 0;
 border-radius:10px;
 border:1px solid #cbd5f5;
 box-sizing:border-box;
 font-size:15px;
}
button{
 width:100%;
 padding:16px;
 border:none;
 border-radius:12px;
 background:#2563eb;
 color:white;
 font-size:17px;
 margin-top:20px;
 cursor:pointer;
 font-weight:600;
}

.offerBox{
 background:#fff;
 padding:12px;
 border-radius:12px;
 margin-top:12px;
 border:1px solid #e2e8f0;
}

.badgeGrid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
 margin-top:10px;
 font-size:14px;
}
.badgeGrid label{
 display:flex;
 gap:8px;
 align-items:center;
 cursor:pointer;
}

.dayBox{
 background:#fff;
 padding:10px;
 border-radius:10px;
 margin-bottom:8px;
 display:grid;
 grid-template-columns:28px 1fr;
 gap:8px;
 align-items:center;
 border:1px solid #e2e8f0;
}
.dayCheck{display:flex;justify-content:center}
.dayContent{display:flex;flex-direction:column;gap:6px}
.dayRow{display:flex;align-items:center;gap:8px}
.dayRow label{font-weight:500;min-width:80px}

.holidayBox{
 background:#fff;
 padding:16px;
 border-radius:12px;
 margin:12px 0;
 border:1px solid #e2e8f0;
}
.holidayHeader{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:12px;
}
.holidayHeader label{
 font-weight:600;
 font-size:16px;
 color:#0f172a;
}
.addHolidayBtn{
 background:#10b981;
 color:white;
 border:none;
 padding:8px 16px;
 border-radius:8px;
 cursor:pointer;
 font-size:14px;
 font-weight:500;
}
.holidayItem{
 display:grid;
 grid-template-columns:1fr 120px auto;
 gap:10px;
 align-items:center;
 margin:8px 0;
 padding:10px;
 background:#f8fafc;
 border-radius:10px;
 border:1px solid #e2e8f0;
}
.holidayItem input[type="text"]{
 padding:10px;
 border:1px solid #e2e8f0;
 border-radius:8px;
 font-size:14px;
 background:white;
}
.holidayItem input[type="date"]{
 padding:10px;
 border:1px solid #e2e8f0;
 border-radius:8px;
 font-size:14px;
 min-width:120px;
 background:white;
 color:#334155;
}
.removeHoliday{
 background:#ef4444;
 color:white;
 border:none;
 border-radius:8px;
 padding:10px 14px;
 cursor:pointer;
 font-size:16px;
 font-weight:bold;
 min-width:40px;
 height:40px;
 display:flex;
 align-items:center;
 justify-content:center;
}
.removeHoliday:hover{
 background:#dc2626;
}
@media (max-width:480px){
 .holidayItem{
  grid-template-columns:1fr;
  gap:8px;
 }
 .holidayItem input[type="date"]{
  min-width:100%;
 }
}

.websiteBox{
 background:#fff;
 padding:12px;
 border-radius:10px;
 margin:12px 0;
 border:1px solid #e2e8f0;
}
.websiteBox label{
 display:block;
 margin-bottom:6px;
 font-weight:600;
 color:#0f172a;
}

/* PAYMENT MODAL STYLES - IMPROVED */
.payment-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
.payment-content {
  background: white;
  border-radius: 16px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.payment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e2e8f0;
}
.payment-header h2 {
  margin: 0;
  color: #0f172a;
}
.close-payment {
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 16px;
}
.payment-option {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s;
}
.payment-option:hover {
  background: #f1f5f9;
  border-color: #2563eb;
}
.payment-option.active {
  background: #dbeafe;
  border-color: #2563eb;
  position: relative;
}
.payment-option.active::after {
  content: "‚úì Selected";
  position: absolute;
  top: -10px;
  right: -10px;
  background: #10b981;
  color: white;
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}
.payment-option h3 {
  margin: 0 0 10px 0;
  color: #0f172a;
  display: flex;
  align-items: center;
  gap: 8px;
}
.payment-details {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e2e8f0;
  display: none;
}
.payment-option.active .payment-details {
  display: block;
}
.payment-input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border: 1px solid #cbd5f5;
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
}
.payment-file {
  width: 100%;
  padding: 10px;
  border: 2px dashed #cbd5f5;
  border-radius: 8px;
  margin: 8px 0;
  text-align: center;
  cursor: pointer;
  background: white;
}
.payment-file:hover {
  border-color: #2563eb;
  background: #f8fafc;
}
.preview-barcode {
  max-width: 200px;
  margin: 10px auto;
  display: block;
  border-radius: 8px;
  border: 2px solid #e2e8f0;
}
.submit-payment {
  width: 100%;
  padding: 14px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 20px;
}
.payment-status {
  margin: 10px 0;
  padding: 8px 12px;
  background: #d1fae5;
  border: 1px solid #10b981;
  border-radius: 8px;
  color: #065f46;
  font-size: 14px;
  display: none;
}
.payment-status.active {
  display: block;
}
</style>

<script>
// Redirect if PWA and has saved card
if ((window.matchMedia('(display-mode: standalone)').matches || navigator.standalone)){
 const last=localStorage.getItem("lastCardId");
 if(last) location.replace("card.html?id="+last);
}
</script>
</head>

<body>
<div class="wrap">

<h2>üë§ Profile</h2>
<input type="file" id="profileImage" accept="image/*">
<input id="fullName" placeholder="Full Name">
<input id="phoneNumber" placeholder="Phone" type="tel">
<input id="email" placeholder="Email" type="email">
<input id="address" placeholder="Address">

<h2>üè¢ Business</h2>
<input id="businessName" placeholder="Business Title">
<textarea id="businessAbout" placeholder="About your business" rows="4"></textarea>

<div class="websiteBox">
 <label>üåê Website / E-commerce Link</label>
 <input type="url" id="website" placeholder="https://example.com">
</div>

<h3>üïê Business Hours</h3>
<div id="daysContainer"></div>

<div class="holidayBox">
 <div class="holidayHeader">
  <label>üìÖ Special Holidays / Closed Days</label>
  <button type="button" class="addHolidayBtn" onclick="addHoliday()">+ Add Holiday</button>
 </div>
 <div id="holidaysContainer">
  <div class="holidayItem">
   <input type="text" class="holidayName" placeholder="E.g., Eid ul-Fitr" value="Eid ul-Fitr">
   <input type="date" class="holidayDate">
   <button type="button" class="removeHoliday" onclick="removeHoliday(this)">√ó</button>
  </div>
  <div class="holidayItem">
   <input type="text" class="holidayName" placeholder="E.g., Quaid Day" value="Quaid Day">
   <input type="date" class="holidayDate">
   <button type="button" class="removeHoliday" onclick="removeHoliday(this)">√ó</button>
  </div>
 </div>
</div>

<h2>üéÅ Offers</h2>
<div id="offersForm"></div>
<button type="button" onclick="addOffer()" style="background:#8b5cf6;margin-top:12px">‚ûï Add Offer</button>

<!-- Payment Button - Shows status -->
<button type="button" onclick="openPaymentModal()" style="background:#059669;margin-top:24px;position:relative;" id="paymentButton">
  üí≥ Add Payment Methods
  <span id="paymentStatusBadge" style="position:absolute;top:-8px;right:-8px;background:#10b981;color:white;border-radius:50%;width:24px;height:24px;display:none;align-items:center;justify-content:center;font-size:12px;font-weight:bold;">‚úì</span>
</button>

<div id="paymentStatus" class="payment-status">
  ‚úì Payment methods added. They will be included in your digital card.
</div>

<button type="button" onclick="generate()" style="background:#2563eb;margin-top:24px">‚ú® Generate Digital Card</button>
</div>

<!-- Payment Modal -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-content">
    <div class="payment-header">
      <h2>üí≥ Payment Methods</h2>
      <button class="close-payment" onclick="closePaymentModal()">√ó</button>
    </div>
    
    <!-- WhatsApp Payment -->
    <div class="payment-option" onclick="selectPayment('whatsapp')" id="whatsappOption">
      <h3>üì± WhatsApp Payment</h3>
      <p>Customers can contact you via WhatsApp for payments</p>
      <div class="payment-details" id="whatsappDetails">
        <input type="text" class="payment-input" id="whatsappNumber" placeholder="WhatsApp Number (e.g., +92 300 1234567)">
        <small style="color:#64748b;display:block;margin-top:5px;">Include country code (+92 for Pakistan)</small>
      </div>
    </div>
    
    <!-- JazzCash / EasyPaisa -->
    <div class="payment-option" onclick="selectPayment('jazzcash')" id="jazzcashOption">
      <h3>üí∞ JazzCash / EasyPaisa</h3>
      <p>Accept payments via JazzCash or EasyPaisa</p>
      <div class="payment-details" id="jazzcashDetails">
        <h4>Choose Payment Method:</h4>
        <select class="payment-input" id="mobileWalletType">
          <option value="jazzcash">JazzCash</option>
          <option value="easypaisa">EasyPaisa</option>
        </select>
        
        <h4 style="margin-top:15px;">Option A: Barcode/QR Code</h4>
        <input type="file" class="payment-file" id="jazzcashBarcode" accept="image/*" onchange="previewBarcode(this)">
        <img id="barcodePreview" class="preview-barcode" style="display:none;">
        
        <h4 style="margin-top:15px;">Option B: Cell Number</h4>
        <input type="text" class="payment-input" id="jazzcashNumber" placeholder="Cell Number (e.g., 0300 1234567)">
        
        <div style="margin-top:10px;font-size:14px;color:#64748b;">
          <strong>Note:</strong> Add at least one payment option.
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button class="submit-payment" onclick="savePaymentMethods()" style="flex:2;">üíæ Save & Continue</button>
      <button onclick="clearPaymentMethods()" style="flex:1;background:#ef4444;color:white;border:none;border-radius:10px;padding:14px;cursor:pointer;">Clear</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// Payment Methods Data - GLOBAL VARIABLE
let paymentMethods = {
  whatsapp: { active: false, number: '' },
  jazzcash: { 
    active: false, 
    type: 'jazzcash',
    barcode: '',
    number: ''
  }
};

// Check if payment methods exist on page load
window.addEventListener('load', function() {
  const saved = localStorage.getItem('paymentMethods');
  if (saved) {
    paymentMethods = JSON.parse(saved);
    updatePaymentUI();
  }
});

// Initialize business hours
const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
days.forEach(d => {
 const dayBox = document.createElement("div");
 dayBox.className = "dayBox";
 dayBox.innerHTML = `
  <div class="dayCheck">
   <input type="checkbox" checked class="dayOpen">
  </div>
  <div class="dayContent">
   <div class="dayRow">
    <label style="min-width:100px">${d}</label>
    <select class="dayStatus" style="width:100px;padding:6px;">
     <option value="open">Open</option>
     <option value="closed">Closed</option>
    </select>
   </div>
   <div class="dayRow">
    <input type="time" class="dayStart" value="09:00" style="width:100px;">
    <span>to</span>
    <input type="time" class="dayEnd" value="17:00" style="width:100px;">
   </div>
  </div>
 `;
 daysContainer.appendChild(dayBox);
 
 const statusSelect = dayBox.querySelector('.dayStatus');
 const timeInputs = dayBox.querySelectorAll('.dayStart, .dayEnd');
 const openCheckbox = dayBox.querySelector('.dayOpen');
 
 statusSelect.addEventListener('change', function() {
  if(this.value === 'closed') {
   timeInputs.forEach(input => input.disabled = true);
   openCheckbox.checked = false;
  } else {
   timeInputs.forEach(input => input.disabled = false);
   openCheckbox.checked = true;
  }
 });
});

// Holiday management
function addHoliday() {
 const container = document.getElementById('holidaysContainer');
 const holidayItem = document.createElement('div');
 holidayItem.className = 'holidayItem';
 holidayItem.innerHTML = `
  <input type="text" class="holidayName" placeholder="E.g., Eid ul-Fitr">
  <input type="date" class="holidayDate">
  <button type="button" class="removeHoliday" onclick="removeHoliday(this)">√ó</button>
 `;
 container.appendChild(holidayItem);
}

function removeHoliday(button) {
 button.parentElement.remove();
}

// Offer management
let offerCount = 0;
function addOffer(){
 offerCount++;
 const box = document.createElement("div");
 box.className = "offerBox";
 box.innerHTML = `
  <h3 style="margin-top:0">üéÅ Offer ${offerCount}</h3>
  <input type="file" class="offerImg" accept="image/*">
  <input class="offerTitle" placeholder="Title (e.g., 20% Off)">
  <textarea class="offerDesc" placeholder="Description (e.g., Valid until Dec 31)" rows="3"></textarea>
  
  <div class="badgeGrid">
   <label><input type="checkbox" value="üî• Hot Deal"> Hot Deal</label>
   <label><input type="checkbox" value="‚≠ê Best Seller"> Best Seller</label>
   <label><input type="checkbox" value="üí∏ Discount"> Discount</label>
   <label><input type="checkbox" value="‚è≥ Limited Time"> Limited Time</label>
   <label><input type="checkbox" value="üöö Free Delivery"> Free Delivery</label>
   <label><input type="checkbox" value="üè∑ Special Price"> Special Price</label>
  </div>
 `;
 offersForm.appendChild(box);
}

// Image compression
function resizeImage(file){
 return new Promise(res => {
  const img = new Image();
  img.onload = () => {
   const canvas = document.createElement("canvas");
   const max = 1024;
   const ratio = Math.min(max/img.width, max/img.height, 1);
   canvas.width = img.width * ratio;
   canvas.height = img.height * ratio;
   const ctx = canvas.getContext("2d");
   ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
   res(canvas.toDataURL("image/jpeg", 0.85));
  };
  img.src = URL.createObjectURL(file);
 });
}

// PAYMENT METHODS FUNCTIONS - IMPROVED
function openPaymentModal() {
  document.getElementById('paymentModal').style.display = 'flex';
  loadPaymentMethods();
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
}

function selectPayment(type) {
  // Remove active class from all
  document.querySelectorAll('.payment-option').forEach(option => {
    option.classList.remove('active');
  });
  
  // Activate selected
  const option = document.getElementById(type + 'Option');
  option.classList.add('active');
}

async function previewBarcode(input) {
  if (input.files && input.files[0]) {
    const compressed = await resizeImage(input.files[0]);
    const preview = document.getElementById('barcodePreview');
    preview.src = compressed;
    preview.style.display = 'block';
    paymentMethods.jazzcash.barcode = compressed;
  }
}

function loadPaymentMethods() {
  // Load saved data
  if (paymentMethods.whatsapp.active) {
    document.getElementById('whatsappNumber').value = paymentMethods.whatsapp.number || '';
    selectPayment('whatsapp');
  } else if (paymentMethods.jazzcash.active) {
    document.getElementById('mobileWalletType').value = paymentMethods.jazzcash.type || 'jazzcash';
    document.getElementById('jazzcashNumber').value = paymentMethods.jazzcash.number || '';
    
    if (paymentMethods.jazzcash.barcode) {
      const preview = document.getElementById('barcodePreview');
      preview.src = paymentMethods.jazzcash.barcode;
      preview.style.display = 'block';
    }
    
    selectPayment('jazzcash');
  }
}

async function savePaymentMethods() {
  // Get current values
  const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
  const jazzcashType = document.getElementById('mobileWalletType').value;
  const jazzcashNumber = document.getElementById('jazzcashNumber').value.trim();
  
  // Get barcode file if exists
  const barcodeFile = document.getElementById('jazzcashBarcode').files[0];
  if (barcodeFile && !paymentMethods.jazzcash.barcode) {
    paymentMethods.jazzcash.barcode = await resizeImage(barcodeFile);
  }
  
  // Update paymentMethods
  paymentMethods.whatsapp.number = whatsappNumber;
  paymentMethods.whatsapp.active = !!whatsappNumber;
  
  paymentMethods.jazzcash.type = jazzcashType;
  paymentMethods.jazzcash.number = jazzcashNumber;
  paymentMethods.jazzcash.active = !!(paymentMethods.jazzcash.barcode || jazzcashNumber);
  
  // Save to localStorage
  localStorage.setItem('paymentMethods', JSON.stringify(paymentMethods));
  
  // Update UI
  updatePaymentUI();
  
  alert('‚úÖ Payment methods saved successfully!');
  closePaymentModal();
}

function clearPaymentMethods() {
  paymentMethods = {
    whatsapp: { active: false, number: '' },
    jazzcash: { 
      active: false, 
      type: 'jazzcash',
      barcode: '',
      number: ''
    }
  };
  
  localStorage.removeItem('paymentMethods');
  
  // Clear form
  document.getElementById('whatsappNumber').value = '';
  document.getElementById('mobileWalletType').value = 'jazzcash';
  document.getElementById('jazzcashNumber').value = '';
  document.getElementById('jazzcashBarcode').value = '';
  document.getElementById('barcodePreview').style.display = 'none';
  
  // Update UI
  updatePaymentUI();
  
  alert('üóëÔ∏è Payment methods cleared!');
}

function updatePaymentUI() {
  const hasPayment = paymentMethods.whatsapp.active || paymentMethods.jazzcash.active;
  
  // Update button badge
  const badge = document.getElementById('paymentStatusBadge');
  const statusDiv = document.getElementById('paymentStatus');
  
  if (hasPayment) {
    badge.style.display = 'flex';
    statusDiv.classList.add('active');
  } else {
    badge.style.display = 'none';
    statusDiv.classList.remove('active');
  }
}

// Generate card - FIXED to include payment methods
async function generate(){
 if(!fullName.value || !phoneNumber.value){
  alert("Name & Phone number are required");
  return;
 }

 const id = crypto.randomUUID();

 // Collect business hours
 const businessHoursArray = [];
 const dayBoxes = document.querySelectorAll(".dayBox");
 dayBoxes.forEach(box => {
  const open = box.querySelector(".dayOpen").checked;
  const status = box.querySelector(".dayStatus").value;
  const start = box.querySelector(".dayStart").value;
  const end = box.querySelector(".dayEnd").value;
  
  businessHoursArray.push({
   open: open && status === 'open',
   status: status,
   start: (open && status === 'open') ? start : null,
   end: (open && status === 'open') ? end : null
  });
 });

 // Collect holidays
 const holidaysArray = [];
 const holidayItems = document.querySelectorAll(".holidayItem");
 holidayItems.forEach(item => {
  const name = item.querySelector(".holidayName").value;
  const date = item.querySelector(".holidayDate").value;
  if(name.trim() && date) {
   holidaysArray.push({
    name: name.trim(),
    date: date
   });
  }
 });

 // Collect offers
 const offersArray = [];
 const offerBoxes = document.querySelectorAll(".offerBox");
 
 for(let i = 0; i < offerBoxes.length; i++){
  const box = offerBoxes[i];
  const title = box.querySelector(".offerTitle").value;
  const desc = box.querySelector(".offerDesc").value;
  const file = box.querySelector(".offerImg").files[0];
  
  if(title || desc || file){
   const badges = Array.from(box.querySelectorAll("input[type=checkbox]:checked"))
    .map(cb => cb.value);
   
   const offerData = {
    title: title || "",
    desc: desc || "",
    badges: badges,
    image: ""
   };
   
   if(file){
    offerData.image = await resizeImage(file);
   }
   
   offersArray.push(offerData);
  }
 }

 // IMPORTANT: Load latest payment methods from localStorage
 const savedPayment = localStorage.getItem('paymentMethods');
 if (savedPayment) {
   paymentMethods = JSON.parse(savedPayment);
 }

 // Prepare data with payment methods
 const cardData = {
  name: fullName.value.trim(),
  phone: phoneNumber.value.trim(),
  email: email.value.trim(),
  address: address.value.trim(),
  website: website.value.trim(),
  businessName: businessName.value.trim(),
  business: {
   about: businessAbout.value.trim()
  },
  businessHours: businessHoursArray,
  holidays: holidaysArray,
  offers: offersArray,
  payments: paymentMethods  // ADDED PAYMENT METHODS
 };

 // Add profile image if exists
 if(profileImage.files[0]){
  cardData.profileImage = await resizeImage(profileImage.files[0]);
 }

 // Save to Supabase
 const { data: inserted, error } = await db.from("cards").insert({
   id: id,
   data: JSON.stringify(cardData)
 }).select().single();

 if(error){
   console.error("Supabase error:", error);
   alert("Failed to save card: " + error.message);
   return;
 }

 // Store ID and redirect
 localStorage.setItem("lastCardId", inserted.id);
 location.href = "card.html?id=" + inserted.id;
}
</script>
</body>
</html>
