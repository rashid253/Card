<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;color:#0f172a;overflow-x:hidden}
.topbar{display:flex;justify-content:space-around;padding:10px;background:#0f172a}
.topbar a{color:white;font-size:18px}
.profile{display:flex;gap:12px;padding:16px;background:#e2e8f0;align-items:center}
.profile img{width:70px;height:70px;border-radius:50%;object-fit:contain;border:2px solid #cbd5f5;background:white}
.info{font-size:13px}
.downloadBtn{display:inline-block;font-size:12px;padding:4px 8px;border-radius:6px;background:#2563eb;color:white;margin-top:6px;cursor:pointer}
.about{padding:12px;background:white;font-size:14px}
.offers{display:flex;overflow-x:auto;scroll-snap-type:x mandatory}
.offer{min-width:90%;margin:12px;background:#2563eb;border-radius:16px;padding:12px;scroll-snap-align:center;color:white;display:flex;gap:12px;align-items:center}
.offer img{max-width:120px;max-height:100px;object-fit:contain;border-radius:8px}
.offerContent{flex:1}
.offer button{width:100%;padding:8px;border:none;border-radius:8px;background:#0f172a;color:white;font-size:14px;margin-top:6px}
.dots{text-align:center;margin-bottom:10px}
.dots span{display:inline-block;width:8px;height:8px;border-radius:50%;background:#94a3b8;margin:0 4px}
.dots .active{background:#2563eb;width:18px;border-radius:10px}
.actions{display:flex;justify-content:space-around;padding:14px;background:#e2e8f0}
.actions a{color:#0f172a;font-size:22px}
.social{display:flex;justify-content:center;gap:18px;padding:10px}
.social a{color:#2563eb;font-size:20px}
</style>
</head>

<body>

<div class="topbar">
<a id="share"><i class="fa fa-share"></i></a>
<a id="map"><i class="fa-solid fa-location-dot"></i></a>
<a id="sms"><i class="fa fa-comment"></i></a>
</div>

<div class="profile">
<img id="photo">
<div class="info">
<div id="name"></div>
<div id="business"></div>
<div id="phone"></div>
<div id="email"></div>
<div id="address"></div>
<div class="downloadBtn" onclick="saveCard()">
 <i class="fa fa-floppy-disk"></i> Save
</div>
</div>
</div>

<div class="about" id="about"></div>
<div class="offers" id="offers"></div>
<div class="dots" id="dots"></div>

<div class="actions">
<a id="call"><i class="fa fa-phone"></i></a>
<a id="wa"><i class="fab fa-whatsapp"></i></a>
<a id="mail"><i class="fa fa-envelope"></i></a>
</div>

<div class="social">
<a id="fb"><i class="fab fa-facebook"></i></a>
<a id="ig"><i class="fab fa-instagram"></i></a>
<a id="yt"><i class="fab fa-youtube"></i></a>
<a id="web"><i class="fa fa-globe"></i></a>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
if('serviceWorker' in navigator){
 navigator.serviceWorker.register("sw.js");
}

const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

/* ===== PWA FIX ===== */
let id = new URLSearchParams(location.search).get("id");

if(id){
 localStorage.setItem("last_card_id", id);
}else{
 id = localStorage.getItem("last_card_id");
}

if(!id){
 document.body.innerHTML="<h2 style='text-align:center'>No card found</h2>";
 throw "No card id";
}
/* =================== */

let cardData = null;

// TRY LOCAL FIRST
const cached = localStorage.getItem("card_"+id);
if(cached){
 loadCard(JSON.parse(cached));
}

// LOAD ONLINE
db.from("cards").select("*").eq("id",id).single().then(r=>{
 if(r.data){
  const data = JSON.parse(r.data.data);
  localStorage.setItem("card_"+id, JSON.stringify(data));
  loadCard(data);
 }
});

function loadCard(data){
 cardData = data;

 photo.src = data.profileImage || "";
 name.textContent = data.name || "";
 business.textContent = data.businessName || "";
 phone.textContent = "ðŸ“ž "+(data.phone||"");
 email.textContent = "âœ‰ï¸ "+(data.email||"");
 address.textContent = "ðŸ“ "+(data.address||"");
 about.textContent = data.businessInfo || "";

 call.href="tel:"+data.phone;

 const mainMsg = `Hello ${data.name},

I found your digital business card.

Business: ${data.businessName}

${location.href}`;

 wa.href="https://wa.me/"+data.phone+"?text="+encodeURIComponent(mainMsg);

 mail.href="mailto:"+data.email;
 map.href="https://maps.google.com/?q="+encodeURIComponent(data.address);
 sms.href="sms:"+data.phone;

 if(data.facebook) fb.href=data.facebook;
 if(data.instagram) ig.href=data.instagram;
 if(data.youtube) yt.href=data.youtube;
 if(data.website) web.href=data.website;

 offers.innerHTML=""; dots.innerHTML="";
 data.offers.forEach((o,i)=>{
  const d=document.createElement("div");
  d.className="offer";
  d.innerHTML=`
   ${o.image?`<img src="${o.image}">`:""}
   <div class="offerContent">
    <h3>ðŸ”¥ ${o.title}</h3>
    <p>${o.desc}</p>
    <button>Grab Offer</button>
   </div>`;
  d.onclick=()=>{
   const msg=`Hello ${data.name}, I am interested in your offer: ${o.title}`;
   location.href="https://wa.me/"+data.phone+"?text="+encodeURIComponent(msg);
  }
  offers.appendChild(d);
  const dot=document.createElement("span");
  if(i==0) dot.classList.add("active");
  dots.appendChild(dot);
 });
}

function saveCard(){
 const vcf = `
BEGIN:VCARD
VERSION:3.0
FN:${cardData.name}
TEL:${cardData.phone}
EMAIL:${cardData.email}
END:VCARD`.trim();

 const blob=new Blob([vcf],{type:"text/vcard"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=cardData.name+".vcf";
 a.click();
}

/* ===== SHARE FIX (ONLY ADDITION) ===== */
share.onclick = async () => {
 const shareData = {
  title: cardData.name,
  text: `Check my digital card:\n${cardData.name}\n${cardData.businessName}`,
  url: location.href
 };

 if(navigator.share){
  await navigator.share(shareData);
 }else{
  navigator.clipboard.writeText(location.href);
  alert("Link copied");
 }
};
/* ==================================== */

// BACK = EXIT APP
history.pushState({}, "");
window.addEventListener("popstate", () => {
 window.close();
});
</script>
</body>
</html>
