<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;color:#0f172a}
.topbar{display:flex;justify-content:space-around;padding:12px;background:#0f172a}
.topbar a{color:#fff;font-size:20px}
.profile{display:flex;gap:16px;padding:16px;background:#e2e8f0;position:relative}
.profile img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid #2563eb;background:#fff}
.info{flex:1;display:flex;flex-direction:column;gap:4px}
#name{font-size:17px;font-weight:700}
#business{font-weight:600}
#phone,#email,#address,#websiteText{font-size:14px;opacity:.85}
.saveIcon{position:absolute;right:14px;bottom:14px;font-size:22px;color:#2563eb;cursor:pointer}
.about{background:#fff;padding:14px 16px;cursor:pointer}
.aboutText{overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
.about.expanded .aboutText{-webkit-line-clamp:unset}
.aboutMore{color:#2563eb;font-weight:600;margin-top:6px;display:inline-block}
.offers{display:flex;gap:12px;padding:12px;overflow-x:auto}
.offer{min-width:160px;height:200px;border-radius:16px;background:#fff;position:relative;cursor:pointer;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.offer img{width:100%;height:100%;object-fit:contain}
.offerBadges{position:absolute;top:10px;left:10px;display:flex;flex-direction:column;gap:6px}
.offerBadges span{background:#ef4444;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:8px}
.offerActions{position:absolute;bottom:10px;right:10px;display:flex;gap:6px}
.offerActionBtn{padding:6px 10px;background:#2563eb;color:white;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer}
.offerActionBtn.shop{background:#10b981}
#offerPanel{position:fixed;inset:0;background:#fff;z-index:999;display:none}
#offerPanel img{width:100%;max-height:280px;object-fit:contain}
.panelContent{padding:16px}
.panelActions{display:flex;gap:12px;margin-top:16px}
.panelCTA{padding:14px;text-align:center;border-radius:12px;font-weight:700;cursor:pointer;flex:1}
.panelCTA.whatsapp{background:#16a34a;color:#fff}
.panelCTA.cart{background:#2563eb;color:#fff}
.actions{display:flex;justify-content:space-around;padding:16px;background:#0f172a}
.actions a{color:#fff;font-size:22px}

/* Business Hours Styles */
.hoursContainer{background:#fff;padding:16px;margin-top:8px;}
.hoursContainer h3{margin:0 0 12px 0;font-size:16px;color:#0f172a;}
.dayRow{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f1f1;}
.dayRow:last-child{border-bottom:none;}
.dayName{font-weight:500;}
.dayTime{color:#666;}
.closed{color:#ef4444;}

/* Website Section */
.websiteContainer{background:#fff;padding:16px;margin-top:8px;}
.websiteContainer h3{margin:0 0 12px 0;font-size:16px;color:#0f172a;}
.websiteLink{display:flex;align-items:center;gap:10px;padding:12px;background:#f8fafc;border-radius:10px;text-decoration:none;color:#2563eb;font-weight:600;margin-top:8px;}
.websiteLink i{font-size:18px;}

/* Holidays Section */
.holidaysContainer{background:#fff;padding:16px;margin-top:8px;}
.holidaysContainer h3{margin:0 0 12px 0;font-size:16px;color:#0f172a;}
.holidayItem{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:8px;}
.holidayName{font-weight:500;color:#0f172a;}
.holidayDate{color:#ef4444;font-size:14px;}

/* Special Text for Website */
.websiteSpecial{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:14px;border-radius:12px;margin:12px;text-align:center;font-weight:700;font-size:15px;}
.websiteSpecial a{color:white;text-decoration:none;}

/* WhatsApp Note */
.whatsappNote{background:#fff;padding:14px;margin:12px;border-radius:12px;border-left:4px solid #25d366;font-size:14px;color:#0f172a;}
.whatsappNote strong{color:#25d366;}

/* Cart Styles */
.cartPanel{position:fixed;inset:0;background:#fff;z-index:1000;display:none;flex-direction:column;}
.cartHeader{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#0f172a;color:white;}
.cartHeader h2{margin:0;font-size:18px;}
.closeCart{background:none;border:none;color:white;font-size:24px;cursor:pointer;}
.cartItems{padding:16px;flex:1;overflow-y:auto;}
.cartItem{display:flex;gap:12px;padding:12px;border-bottom:1px solid #e2e8f0;align-items:center;}
.cartItem img{width:60px;height:60px;object-fit:cover;border-radius:8px;}
.cartItemInfo{flex:1;}
.cartItemTitle{font-weight:600;margin-bottom:4px;}
.cartItemPrice{color:#2563eb;font-weight:600;}
.cartItemActions{display:flex;gap:8px;align-items:center;}
.cartItemQty{display:flex;align-items:center;gap:6px;}
.cartItemQty button{width:28px;height:28px;border-radius:6px;border:1px solid #cbd5e1;background:white;cursor:pointer;}
.cartRemove{color:#ef4444;background:none;border:none;cursor:pointer;}
.cartFooter{padding:16px;background:#f8fafc;border-top:1px solid #e2e8f0;}
.cartTotal{display:flex;justify-content:space-between;font-weight:600;font-size:18px;margin-bottom:16px;}
.cartCheckout{background:#2563eb;color:white;border:none;padding:16px;width:100%;border-radius:12px;font-weight:600;cursor:pointer;}

/* Payment Modal */
.paymentModal{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1001;display:none;justify-content:center;align-items:center;}
.paymentContent{background:white;padding:20px;border-radius:16px;max-width:400px;width:90%;}
.paymentHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.paymentHeader h3{margin:0;}
.closePayment{background:none;border:none;font-size:24px;cursor:pointer;}
.jazzcashQr{text-align:center;margin:16px 0;}
.jazzcashQr img{max-width:200px;max-height:200px;border-radius:8px;}
.jazzcashNumber{text-align:center;padding:16px;background:#f8fafc;border-radius:8px;margin:16px 0;}
.jazzcashNumber code{font-size:18px;color:#2563eb;font-weight:600;}
.paymentNote{font-size:12px;color:#666;margin-top:8px;}
</style>
</head>

<body>

<div class="topbar">
 <a id="map"><i class="fa-solid fa-location-dot"></i></a>
 <a id="share" onclick="shareCard()"><i class="fa-solid fa-share-nodes"></i></a>
 <a id="cart" onclick="openCart()"><i class="fa-solid fa-cart-shopping"></i></a>
</div>

<div class="profile">
 <img id="photo">
 <div class="info">
  <div id="name"></div>
  <div id="business"></div>
  <div id="phone"></div>
  <div id="email"></div>
  <div id="address"></div>
  <div id="websiteText"></div>
 </div>
 <i class="fa fa-floppy-disk saveIcon" onclick="saveCard()"></i>
</div>

<div class="about" id="aboutBox" onclick="toggleAbout()">
 <div class="aboutText" id="aboutText"></div>
 <span class="aboutMore" id="aboutMore">See more</span>
</div>

<!-- Website Section -->
<div class="websiteContainer" id="websiteContainer" style="display:none;">
 <h3>üåê Visit Our Website</h3>
 <a class="websiteLink" id="websiteLink" target="_blank" rel="noopener">
  <i class="fas fa-external-link-alt"></i>
  <span id="websiteUrl"></span>
 </a>
</div>

<!-- Business Hours Section -->
<div class="hoursContainer" id="hoursContainer" style="display:none;">
 <h3>üïê Business Hours</h3>
 <div id="businessHours"></div>
</div>

<!-- Holidays Section -->
<div class="holidaysContainer" id="holidaysContainer" style="display:none;">
 <h3>üìÖ Special Holidays</h3>
 <div id="holidaysList"></div>
</div>

<!-- Special Website Banner -->
<div class="websiteSpecial" id="websiteBanner" style="display:none;">
 <a id="websiteBannerLink" target="_blank" rel="noopener">
  üõí Shop Now on Our Online Store! Get Exclusive Offers! üåü
 </a>
</div>

<div class="offers" id="offers"></div>

<!-- WhatsApp Note -->
<div class="whatsappNote" id="whatsappNote">
 <strong>üí¨ Quick WhatsApp Message:</strong><br>
 Tap WhatsApp icon below to send a message directly. Please mention your inquiry clearly.
</div>

<div class="actions">
 <a id="call"><i class="fa fa-phone"></i></a>
 <a id="whatsappAction"><i class="fab fa-whatsapp"></i></a>
 <a id="mail"><i class="fa fa-envelope"></i></a>
</div>

<!-- Cart Panel -->
<div class="cartPanel" id="cartPanel">
 <div class="cartHeader">
  <h2>üõí Your Cart</h2>
  <button class="closeCart" onclick="closeCart()">√ó</button>
 </div>
 <div class="cartItems" id="cartItems">
  <!-- Cart items will be added here -->
 </div>
 <div class="cartFooter">
  <div class="cartTotal">
   <span>Total:</span>
   <span id="cartTotalAmount">Rs 0</span>
  </div>
  <button class="cartCheckout" onclick="checkout()">Proceed to Checkout</button>
 </div>
</div>

<!-- Payment Modal -->
<div class="paymentModal" id="paymentModal">
 <div class="paymentContent">
  <div class="paymentHeader">
   <h3>üí≥ Payment Method</h3>
   <button class="closePayment" onclick="closePayment()">√ó</button>
  </div>
  <div id="paymentOptions">
   <!-- Payment options will be loaded here -->
  </div>
 </div>
</div>

<!-- Offer Details Panel -->
<div id="offerPanel">
 <img id="panelImg">
 <div class="panelContent">
  <h2 id="panelTitle"></h2>
  <p id="panelDesc"></p>
  <div class="panelActions">
   <div class="panelCTA whatsapp" id="panelWhatsApp">WhatsApp</div>
   <div class="panelCTA cart" id="panelCart">Add to Cart</div>
  </div>
 </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
document.addEventListener("DOMContentLoaded", async ()=>{

const $=id=>document.getElementById(id);

const photo=$("photo"), nameEl=$("name"), businessEl=$("business"),
phoneEl=$("phone"), emailEl=$("email"), addressEl=$("address"), websiteText=$("websiteText"),
aboutText=$("aboutText"), aboutMore=$("aboutMore"), aboutBox=$("aboutBox"),
offers=$("offers"), call=$("call"), mail=$("mail"), map=$("map"), share=$("share"),
cartBtn=$("cart"), whatsappAction=$("whatsappAction"),
panelImg=$("panelImg"), panelTitle=$("panelTitle"), panelDesc=$("panelDesc"),
panelWhatsApp=$("panelWhatsApp"), panelCart=$("panelCart"), offerPanel=$("offerPanel"),
hoursContainer=$("hoursContainer"), businessHours=$("businessHours"),
holidaysContainer=$("holidaysContainer"), holidaysList=$("holidaysList"),
websiteContainer=$("websiteContainer"), websiteLink=$("websiteLink"), websiteUrl=$("websiteUrl"),
websiteBanner=$("websiteBanner"), websiteBannerLink=$("websiteBannerLink"),
whatsappNote=$("whatsappNote"),
cartPanel=$("cartPanel"), cartItems=$("cartItems"), cartTotalAmount=$("cartTotalAmount"),
paymentModal=$("paymentModal"), paymentOptions=$("paymentOptions");

let currentCard = null;
let cart = JSON.parse(localStorage.getItem('cart_' + id)) || [];
let currentOffer = null;

const supa = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

const idParam=new URLSearchParams(location.search).get("id") || localStorage.getItem("lastCardId");
if(!idParam){document.body.innerHTML="<h2 style='padding:20px'>No card found</h2>";return;}

const {data,error}=await supa.from("cards").select("*").eq("id",idParam).single();
if(error || !data){document.body.innerHTML="<h2 style='padding:20px'>Card not found</h2>";return;}

currentCard = JSON.parse(data.data);
const card = currentCard;

// Populate basic info
photo.src=card.profileImage||"";
nameEl.textContent=card.name||"";
businessEl.textContent=card.businessName||"";
phoneEl.textContent="üìû "+(card.phone||"");
emailEl.textContent="‚úâÔ∏è "+(card.email||"");
addressEl.textContent="üìç "+(card.address||"");
aboutText.textContent=card.business?.about||card.about||"";

// Website info
if(card.website && card.website.trim()) {
 websiteText.textContent="üåê " + card.website;
 websiteContainer.style.display="block";
 websiteUrl.textContent = card.website;
 websiteLink.href = card.website;
 
 // Show special banner
 websiteBanner.style.display="block";
 websiteBannerLink.href = card.website;
}

call.href="tel:"+card.phone;
mail.href="mailto:"+card.email;
map.href="https://maps.google.com/?q="+encodeURIComponent(card.address);
whatsappAction.href=`https://wa.me/${card.phone.replace(/\D/g,"")}`;

// Populate business hours if they exist
if(card.businessHours && Array.isArray(card.businessHours) && card.businessHours.length > 0){
 hoursContainer.style.display = "block";
 const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
 
 card.businessHours.forEach((day, index) => {
   if(day && day.open !== undefined) {
     const dayDiv = document.createElement("div");
     dayDiv.className = "dayRow";
     
     if(!day.open || day.status === 'closed') {
       dayDiv.innerHTML = `
         <span class="dayName">${days[index]}</span>
         <span class="dayTime closed">Closed</span>
       `;
     } else {
       dayDiv.innerHTML = `
         <span class="dayName">${days[index]}</span>
         <span class="dayTime">${day.start} - ${day.end}</span>
       `;
     }
     
     businessHours.appendChild(dayDiv);
   }
 });
}

// Populate holidays if they exist
if(card.holidays && Array.isArray(card.holidays) && card.holidays.length > 0){
 holidaysContainer.style.display = "block";
 
 card.holidays.forEach(holiday => {
   if(holiday.name && holiday.date) {
     const holidayDiv = document.createElement("div");
     holidayDiv.className = "holidayItem";
     
     // Format date
     const date = new Date(holiday.date);
     const formattedDate = date.toLocaleDateString('en-US', {
       month: 'short',
       day: 'numeric',
       year: 'numeric'
     });
     
     holidayDiv.innerHTML = `
       <span class="holidayName">${holiday.name}</span>
       <span class="holidayDate">${formattedDate}</span>
     `;
     
     holidaysList.appendChild(holidayDiv);
   }
 });
}

// Populate offers
offers.innerHTML="";
(card.offers||[]).forEach((o, index)=>{
 if(!o.title && !o.image) return;
 
 const d=document.createElement("div");
 d.className="offer";
 d.innerHTML=`<img src="${o.image||''}" onerror="this.style.display='none'">
 <div class="offerBadges">${(o.badges||[]).map(b=>`<span>${b}</span>`).join("")}</div>
 <div class="offerActions">
  <div class="offerActionBtn shop" onclick="event.stopPropagation();openOffer(${index})">Shop Now</div>
  <div class="offerActionBtn" onclick="event.stopPropagation();addToCart(${index})">Add to Cart</div>
 </div>`;
 
 if(o.title) {
   const titleOverlay = document.createElement("div");
   titleOverlay.style.cssText = "position:absolute;bottom:40px;left:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:6px;border-radius:8px;font-size:12px;text-align:center;";
   titleOverlay.textContent = o.title;
   d.appendChild(titleOverlay);
 }
 
 d.onclick=()=>openOffer(index);
 offers.appendChild(d);
});

// If no offers, hide the offers section
if((card.offers||[]).length === 0) {
 offers.style.display = "none";
 whatsappNote.style.display = "none";
}

// Functions
window.toggleAbout=()=>{
 aboutBox.classList.toggle("expanded");
 aboutMore.textContent=aboutBox.classList.contains("expanded")?"See less":"See more";
};

window.shareCard=()=>{
 if(navigator.share){
  navigator.share({
   title: card.businessName || card.name,
   text: `Check out ${card.name}'s digital card`,
   url: window.location.href
  });
 }else{
  navigator.clipboard.writeText(window.location.href);
  alert("Link copied to clipboard!");
 }
};

window.saveCard=()=>{
 const vcard = `BEGIN:VCARD
VERSION:3.0
FN:${card.name}
ORG:${card.businessName}
TEL:${card.phone}
EMAIL:${card.email}
ADR:${card.address}
URL:${card.website||''}
NOTE:${card.business?.about||''}
END:VCARD`;

 const blob = new Blob([vcard], { type: 'text/vcard' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `${card.name.replace(/\s+/g, '_')}_contact.vcf`;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
 URL.revokeObjectURL(url);
 
 alert("Contact saved as vCard file!");
};

window.openOffer = (index) => {
 const o = card.offers[index];
 currentOffer = o;
 
 panelImg.src = o.image||'';
 panelTitle.textContent = o.title||'';
 panelDesc.textContent = o.desc||'';
 
 panelWhatsApp.onclick = () => {
  location.href = `https://wa.me/${card.phone.replace(/\D/g,"")}?text=Hi! I'm interested in your offer: ${encodeURIComponent(o.title||'')}`;
 };
 
 panelCart.onclick = () => {
  addToCart(index);
  offerPanel.style.display = "none";
 };
 
 offerPanel.style.display = "block";
};

window.addToCart = (index) => {
 const o = card.offers[index];
 const cartItem = {
  id: Date.now() + index,
  title: o.title,
  image: o.image,
  price: 0,
  quantity: 1,
  offerIndex: index
 };
 
 cart.push(cartItem);
 localStorage.setItem('cart_' + idParam, JSON.stringify(cart));
 updateCartDisplay();
 alert("Added to cart!");
};

window.openCart = () => {
 updateCartDisplay();
 cartPanel.style.display = "flex";
};

window.closeCart = () => {
 cartPanel.style.display = "none";
};

window.updateCartDisplay = () => {
 cartItems.innerHTML = "";
 let total = 0;
 
 cart.forEach((item, idx) => {
  const itemDiv = document.createElement("div");
  itemDiv.className = "cartItem";
  itemDiv.innerHTML = `
   <img src="${item.image || ''}" onerror="this.style.visibility='hidden'">
   <div class="cartItemInfo">
    <div class="cartItemTitle">${item.title}</div>
    <div class="cartItemPrice">Price: Rs ${item.price}</div>
   </div>
   <div class="cartItemActions">
    <div class="cartItemQty">
     <button onclick="updateQuantity(${idx}, ${item.quantity - 1})">-</button>
     <span>${item.quantity}</span>
     <button onclick="updateQuantity(${idx}, ${item.quantity + 1})">+</button>
    </div>
    <button class="cartRemove" onclick="removeFromCart(${idx})">
     <i class="fas fa-trash"></i>
    </button>
   </div>
  `;
  cartItems.appendChild(itemDiv);
  total += item.price * item.quantity;
 });
 
 cartTotalAmount.textContent = `Rs ${total}`;
};

window.updateQuantity = (index, newQty) => {
 if(newQty < 1) {
  removeFromCart(index);
  return;
 }
 cart[index].quantity = newQty;
 localStorage.setItem('cart_' + idParam, JSON.stringify(cart));
 updateCartDisplay();
};

window.removeFromCart = (index) => {
 cart.splice(index, 1);
 localStorage.setItem('cart_' + idParam, JSON.stringify(cart));
 updateCartDisplay();
};

window.checkout = () => {
 closeCart();
 
 paymentOptions.innerHTML = `
  <div style="text-align:center;margin-bottom:16px;">
   <h4>Select Payment Method</h4>
  </div>
 `;
 
 if(card.paymentMethod === 'whatsapp') {
  paymentOptions.innerHTML += `
   <button onclick="checkoutWhatsApp()" style="width:100%;padding:16px;background:#25d366;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:12px;">
    <i class="fab fa-whatsapp"></i> Order via WhatsApp
   </button>
   <div class="paymentNote">You'll be redirected to WhatsApp to confirm your order</div>
  `;
 }
 
 if(card.paymentMethod === 'jazzcash') {
  paymentOptions.innerHTML += `
   <button onclick="checkoutJazzCash()" style="width:100%;padding:16px;background:#e6007e;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:12px;">
    <i class="fas fa-mobile-alt"></i> Pay via JazzCash
   </button>
  `;
   
   if(card.jazzcash && card.jazzcash.qr) {
    paymentOptions.innerHTML += `
     <div class="jazzcashQr">
      <h4>Scan QR Code</h4>
      <img src="${card.jazzcash.qr}">
     </div>
    `;
   }
   
   if(card.jazzcash && card.jazzcash.number) {
    paymentOptions.innerHTML += `
     <div class="jazzcashNumber">
      <h4>Send to Account</h4>
      <code>${card.jazzcash.number}</code>
      <div class="paymentNote">Send payment to this JazzCash account number</div>
     </div>
    `;
   }
 }
 
 paymentModal.style.display = "flex";
};

window.closePayment = () => {
 paymentModal.style.display = "none";
};

window.checkoutWhatsApp = () => {
 const itemsText = cart.map(item => `‚Ä¢ ${item.title} x${item.quantity}`).join('\n');
 const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
 const message = `Hello! I would like to place an order:\n\n${itemsText}\n\nTotal: Rs ${total}\n\nName: \nAddress: \nPhone:`;
 
 location.href = `https://wa.me/${card.phone.replace(/\D/g,"")}?text=${encodeURIComponent(message)}`;
};

window.checkoutJazzCash = () => {
 const itemsText = cart.map(item => `‚Ä¢ ${item.title} x${item.quantity}`).join('\n');
 const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
 const message = `Hello! I have made JazzCash payment for:\n\n${itemsText}\n\nTotal: Rs ${total}\nTransaction ID: \nName: \nAddress: \nPhone:`;
 
 location.href = `https://wa.me/${card.phone.replace(/\D/g,"")}?text=${encodeURIComponent(message)}`;
};

// Close panels when clicking outside
offerPanel.onclick = (e) => {
 if(e.target === offerPanel) {
  offerPanel.style.display = "none";
 }
};

paymentModal.onclick = (e) => {
 if(e.target === paymentModal) {
  closePayment();
 }
};

// Initialize cart display
updateCartDisplay();
});
</script>
</body>
</html>
