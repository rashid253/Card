<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{
 margin:0;
 font-family:system-ui;
 background:#f1f5f9;
 color:#0f172a;
 font-size:15px;
 line-height:1.5;
 -webkit-font-smoothing:antialiased;
 overflow-x:hidden
}

.topbar{
 display:flex;
 justify-content:space-around;
 padding:12px;
 background:#0f172a
}
.topbar a{
 color:white;
 font-size:20px
}

.profile{
 display:flex;
 gap:14px;
 padding:16px;
 background:#e2e8f0;
 align-items:center
}

/* LEFT SIDE */
.profileLeft{
 display:flex;
 flex-direction:column;
 align-items:center;
 min-width:100px;
}

/* BIG STANDARD IMAGE */
.profile img{
 width:96px;
 height:96px;
 border-radius:50%;
 object-fit:cover;
 border:3px solid #2563eb;
 background:white
}

/* NAME FIX */
#name{
 font-size:17px;
 font-weight:600;
 margin-top:6px;
 text-align:center;
}

/* RIGHT SIDE */
.info{
 font-size:14px;
 flex:1
}
#business{
 font-size:15px;
 font-weight:700;
 margin-bottom:4px;
}

/* FLOPPY ICON */
.saveIcon{
 font-size:20px;
 color:#2563eb;
 cursor:pointer;
 padding:8px;
 border-radius:50%;
 background:white;
 box-shadow:0 2px 6px rgba(0,0,0,.15);
}

/* ABOUT */
.about{
 padding:12px;
 background:white;
 font-size:14px
}

/* OFFERS */
.offers{
 display:flex;
 overflow-x:auto;
 scroll-snap-type:x mandatory
}
.offer{
 min-width:90%;
 margin:12px;
 background:#2563eb;
 border-radius:18px;
 padding:14px;
 scroll-snap-align:center;
 color:white;
 display:flex;
 gap:12px;
 align-items:center
}

.offer img{
 max-width:120px;
 max-height:100px;
 object-fit:contain;
 border-radius:10px
}

.offerContent{flex:1}

.offer button{
 width:100%;
 padding:10px;
 border:none;
 border-radius:10px;
 background:#0f172a;
 color:white;
 font-size:14px;
 margin-top:8px
}

/* DOTS */
.dots{text-align:center;margin-bottom:10px}
.dots span{
 display:inline-block;
 width:8px;
 height:8px;
 border-radius:50%;
 background:#94a3b8;
 margin:0 4px;
 transition:.3s
}
.dots .active{
 background:#2563eb;
 width:20px;
 border-radius:10px
}

/* ACTIONS ICONS MODERN */
.actions{
 display:flex;
 justify-content:space-around;
 padding:14px;
 background:#e2e8f0
}
.actions a{
 color:#0f172a;
 font-size:22px;
 background:white;
 padding:10px;
 border-radius:50%;
 box-shadow:0 2px 6px rgba(0,0,0,.15);
}

/* SOCIAL */
.social{
 display:flex;
 justify-content:center;
 gap:18px;
 padding:12px
}
.social a{
 color:#2563eb;
 font-size:22px;
 background:white;
 padding:8px;
 border-radius:50%;
 box-shadow:0 2px 6px rgba(0,0,0,.15);
}
</style>
</head>

<body>

<div class="topbar">
<a id="share"><i class="fa-solid fa-share-nodes"></i></a>
<a id="map"><i class="fa-solid fa-location-dot"></i></a>
<a id="sms"><i class="fa-solid fa-comment-dots"></i></a>
</div>

<div class="profile">
 <div class="profileLeft">
  <img id="photo">
  <div id="name"></div>
 </div>

 <div class="info">
  <div id="business"></div>
  <div id="phone"></div>
  <div id="email"></div>
  <div id="address"></div>
 </div>

 <div class="saveIcon" onclick="saveCard()">
  <i class="fa-solid fa-floppy-disk"></i>
 </div>
</div>

<div class="about" id="about"></div>
<div class="offers" id="offers"></div>
<div class="dots" id="dots"></div>

<div class="actions">
<a id="call"><i class="fa-solid fa-phone"></i></a>
<a id="wa"><i class="fab fa-whatsapp"></i></a>
<a id="mail"><i class="fa-solid fa-envelope"></i></a>
</div>

<div class="social">
<a id="fb"><i class="fab fa-facebook"></i></a>
<a id="ig"><i class="fab fa-instagram"></i></a>
<a id="yt"><i class="fab fa-youtube"></i></a>
<a id="web"><i class="fa-solid fa-globe"></i></a>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
if('serviceWorker' in navigator){
 navigator.serviceWorker.register("sw.js");
}

const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

let id=new URLSearchParams(location.search).get("id");
if(id) localStorage.setItem("last_card_id",id);
else id=localStorage.getItem("last_card_id");
if(!id){document.body.innerHTML="No card";throw "";}

let cardData=null;

const cached=localStorage.getItem("card_"+id);
if(cached) loadCard(JSON.parse(cached));

db.from("cards").select("*").eq("id",id).single().then(r=>{
 if(r.data){
  const data=JSON.parse(r.data.data);
  localStorage.setItem("card_"+id,JSON.stringify(data));
  loadCard(data);
 }
});

function loadCard(data){
 cardData=data;

 photo.src=data.profileImage||"";
 name.textContent=data.name||"";   // <-- THIS WAS BUG, now fixed
 business.textContent=data.businessName||"";
 phone.textContent="ðŸ“ž "+(data.phone||"");
 email.textContent="âœ‰ï¸ "+(data.email||"");
 address.textContent="ðŸ“ "+(data.address||"");
 about.textContent=data.businessInfo||"";

 call.href="tel:"+data.phone;
 wa.href="https://wa.me/"+data.phone;
 mail.href="mailto:"+data.email;
 map.href="https://maps.google.com/?q="+encodeURIComponent(data.address);
 sms.href="sms:"+data.phone;

 if(data.facebook) fb.href=data.facebook;
 if(data.instagram) ig.href=data.instagram;
 if(data.youtube) yt.href=data.youtube;
 if(data.website) web.href=data.website;

 offers.innerHTML=""; dots.innerHTML="";
 data.offers.forEach((o,i)=>{
  const d=document.createElement("div");
  d.className="offer";

  let btnText = o.type==="call" ? "Call Now" : "Order Now";

  d.innerHTML=`
   ${o.image?`<img src="${o.image}">`:""}
   <div class="offerContent">
    <h3>${o.title}</h3>
    <p>${o.desc}</p>
    <button>${btnText}</button>
   </div>`;

  d.onclick=()=>{
   const msg=`Hello ${data.name}, I am interested in your offer: ${o.title}`;
   location.href="https://wa.me/"+data.phone+"?text="+encodeURIComponent(msg);
  }

  offers.appendChild(d);

  const dot=document.createElement("span");
  if(i==0) dot.classList.add("active");
  dots.appendChild(dot);
 });

 offers.addEventListener("scroll",()=>{
  const index=Math.round(offers.scrollLeft / offers.offsetWidth);
  [...dots.children].forEach((d,i)=>{
   d.classList.toggle("active", i===index);
  });
 });
}

function saveCard(){
 const vcf=`BEGIN:VCARD
VERSION:3.0
FN:${cardData.name}
TEL:${cardData.phone}
EMAIL:${cardData.email}
END:VCARD`;
 const blob=new Blob([vcf],{type:"text/vcard"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=cardData.name+".vcf";
 a.click();
}

share.onclick=()=>{
 if(navigator.share){
  navigator.share({
   title:cardData.name,
   text:cardData.businessName,
   url:location.href
  });
 }else{
  navigator.clipboard.writeText(location.href);
  alert("Link copied");
 }
};
</script>
</body>
</html>
