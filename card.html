<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;color:#0f172a}
.topbar{display:flex;justify-content:space-around;padding:12px;background:#0f172a}
.topbar a{color:#fff;font-size:20px}
.profile{display:flex;gap:16px;padding:16px;background:#e2e8f0;position:relative}
.profile img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid #2563eb;background:#fff}
.info{flex:1;display:flex;flex-direction:column;gap:4px}
#name{font-size:17px;font-weight:700}
#business{font-weight:600}
#phone,#email,#address{font-size:14px;opacity:.85}
.saveIcon{position:absolute;right:14px;bottom:14px;font-size:22px;color:#2563eb;cursor:pointer}
.about{background:#fff;padding:14px 16px;cursor:pointer}
.aboutText{overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
.about.expanded .aboutText{-webkit-line-clamp:unset}
.aboutMore{color:#2563eb;font-weight:600;margin-top:6px;display:inline-block}
.offers{display:flex;gap:12px;padding:12px;overflow-x:auto}
.offer{min-width:160px;height:200px;border-radius:16px;background:#fff;position:relative;cursor:pointer}
.offer img{width:100%;height:100%;object-fit:contain}
.offerBadges{position:absolute;top:10px;left:10px;display:flex;flex-direction:column;gap:6px}
.offerBadges span{background:#ef4444;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:8px}
#offerPanel{position:fixed;inset:0;background:#fff;z-index:999;display:none}
#offerPanel img{width:100%;max-height:280px;object-fit:contain}
.panelContent{padding:16px}
.panelCTA{margin-top:16px;background:#16a34a;color:#fff;padding:16px;text-align:center;border-radius:12px;font-weight:700;cursor:pointer}
.actions{display:flex;justify-content:space-around;padding:16px;background:#0f172a}
.actions a{color:#fff;font-size:22px}

/* Business Hours Styles */
.hoursContainer{background:#fff;padding:16px;margin-top:8px;}
.hoursContainer h3{margin:0 0 12px 0;font-size:16px;}
.dayRow{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f1f1;}
.dayRow:last-child{border-bottom:none;}
.dayName{font-weight:500;}
.dayTime{color:#666;}
.closed{color:#ef4444;}
</style>
</head>

<body>

<div class="topbar">
 <a id="map"><i class="fa-solid fa-location-dot"></i></a>
 <a id="sms"><i class="fa fa-comment"></i></a>
</div>

<div class="profile">
 <img id="photo">
 <div class="info">
  <div id="name"></div>
  <div id="business"></div>
  <div id="phone"></div>
  <div id="email"></div>
  <div id="address"></div>
 </div>
 <i class="fa fa-floppy-disk saveIcon" onclick="saveCard()"></i>
</div>

<div class="about" id="aboutBox" onclick="toggleAbout()">
 <div class="aboutText" id="aboutText"></div>
 <span class="aboutMore" id="aboutMore">See more</span>
</div>

<!-- Business Hours Section -->
<div class="hoursContainer" id="hoursContainer" style="display:none;">
 <h3>üïê Business Hours</h3>
 <div id="businessHours"></div>
</div>

<div class="offers" id="offers"></div>

<div class="actions">
 <a id="call"><i class="fa fa-phone"></i></a>
 <a id="mail"><i class="fa fa-envelope"></i></a>
</div>

<div id="offerPanel">
 <img id="panelImg">
 <div class="panelContent">
  <h2 id="panelTitle"></h2>
  <p id="panelDesc"></p>
  <div class="panelCTA" id="panelCTA">WhatsApp</div>
 </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
document.addEventListener("DOMContentLoaded", async ()=>{

const $=id=>document.getElementById(id);

const photo=$("photo"), nameEl=$("name"), businessEl=$("business"),
phoneEl=$("phone"), emailEl=$("email"), addressEl=$("address"),
aboutText=$("aboutText"), aboutMore=$("aboutMore"), aboutBox=$("aboutBox"),
offers=$("offers"), call=$("call"), mail=$("mail"), map=$("map"), sms=$("sms"),
panelImg=$("panelImg"), panelTitle=$("panelTitle"), panelDesc=$("panelDesc"),
panelCTA=$("panelCTA"), offerPanel=$("offerPanel"),
hoursContainer=$("hoursContainer"), businessHours=$("businessHours");

const supa = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

const id=new URLSearchParams(location.search).get("id") || localStorage.getItem("lastCardId");
if(!id){document.body.innerHTML="<h2>No card found</h2>";return;}

const {data,error}=await supa.from("cards").select("*").eq("id",id).single();
if(error || !data){document.body.innerHTML="<h2>Card not found</h2>";return;}

const card=JSON.parse(data.data);

// Populate basic info
photo.src=card.profileImage||"";
nameEl.textContent=card.name||"";
businessEl.textContent=card.businessName||"";
phoneEl.textContent="üìû "+(card.phone||"");
emailEl.textContent="‚úâÔ∏è "+(card.email||"");
addressEl.textContent="üìç "+(card.address||"");
aboutText.textContent=card.business?.about||card.about||"";

call.href="tel:"+card.phone;
mail.href="mailto:"+card.email;
map.href="https://maps.google.com/?q="+encodeURIComponent(card.address);
sms.href="sms:"+card.phone;

// Populate business hours if they exist
if(card.businessHours && Array.isArray(card.businessHours) && card.businessHours.length > 0){
 hoursContainer.style.display = "block";
 const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
 
 card.businessHours.forEach((day, index) => {
   if(day && day.open !== undefined) {
     const dayDiv = document.createElement("div");
     dayDiv.className = "dayRow";
     
     if(!day.open || !day.start || !day.end) {
       dayDiv.innerHTML = `
         <span class="dayName">${days[index]}</span>
         <span class="dayTime closed">Closed</span>
       `;
     } else {
       dayDiv.innerHTML = `
         <span class="dayName">${days[index]}</span>
         <span class="dayTime">${day.start} - ${day.end}</span>
       `;
     }
     
     businessHours.appendChild(dayDiv);
   }
 });
}

// Populate offers
offers.innerHTML="";
(card.offers||[]).forEach(o=>{
 if(!o.title && !o.image) return;
 
 const d=document.createElement("div");
 d.className="offer";
 d.innerHTML=`<img src="${o.image||''}" onerror="this.style.display='none'">
 <div class="offerBadges">${(o.badges||[]).map(b=>`<span>${b}</span>`).join("")}</div>`;
 
 if(o.title) {
   const titleOverlay = document.createElement("div");
   titleOverlay.style.cssText = "position:absolute;bottom:10px;left:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:6px;border-radius:8px;font-size:12px;text-align:center;";
   titleOverlay.textContent = o.title;
   d.appendChild(titleOverlay);
 }
 
 d.onclick=()=>{
  panelImg.src=o.image||'';
  panelTitle.textContent=o.title||'';
  panelDesc.textContent=o.desc||'';
  panelCTA.onclick=()=>location.href=`https://wa.me/${card.phone.replace(/\D/g,"")}?text=Hi! I'm interested in your offer: ${encodeURIComponent(o.title||'')}`;
  offerPanel.style.display="block";
 };
 offers.appendChild(d);
});

// If no offers, hide the offers section
if((card.offers||[]).length === 0) {
 offers.style.display = "none";
}

window.toggleAbout=()=>{
 aboutBox.classList.toggle("expanded");
 aboutMore.textContent=aboutBox.classList.contains("expanded")?"See less":"See more";
};

window.saveCard=()=>{
 alert("Contact saved to your device");
 // You could implement actual contact saving here using Web Share API or similar
};

// Close offer panel when clicking outside
offerPanel.onclick = (e) => {
 if(e.target === offerPanel) {
  offerPanel.style.display = "none";
 }
};
});
</script>
</body>
</html>
