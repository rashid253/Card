<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faisalabad Bazar</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --primary:#2563eb;
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --radius:12px;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
/* SPLASH SCREEN */
#splash{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--primary);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;transition:opacity 0.8s}
#splash img{width:120px;height:120px;object-fit:cover;border-radius:12px;margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,.3)}
#splash h1{font-size:24px;margin:0;font-weight:700}
#splash p{font-size:16px;margin-top:6px;opacity:0.9;font-style:italic}

/* HEADER */
.header{background:var(--primary);color:white;font-size:20px;font-weight:600;padding:16px;text-align:center;position:sticky;top:0;z-index:10;cursor:pointer}

/* TRENDING CARDS */
.trending-container{padding:12px;overflow-x:auto;display:flex;gap:12px;scroll-snap-type:x mandatory;scroll-behavior:smooth}
.trending-card{min-width:150px;border-radius:var(--radius);background:white;box-shadow:0 4px 12px rgba(0,0,0,.15);scroll-snap-align:start;cursor:pointer;flex-shrink:0;display:flex;flex-direction:column;align-items:center;padding:8px;transition:.25s;position:relative;}
.trending-card img{width:100%;height:100px;object-fit:cover;border-radius:8px;margin-bottom:6px}
.trending-card .hot-badge{position:absolute;top:8px;left:8px;background:red;color:white;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:600}

/* OFFERS CAROUSEL */
.carousel-container{margin-top:12px;overflow-x:auto;display:flex;scroll-snap-type:x mandatory;padding-bottom:10px;scroll-behavior:smooth}
.offer-card{min-width:80%;background:var(--primary);color:white;border-radius:var(--radius);margin-left:12px;padding:12px;scroll-snap-align:center;display:flex;gap:12px;align-items:center;box-shadow:0 6px 15px rgba(0,0,0,.15);flex-shrink:0;cursor:pointer;transition:.3s;position:relative}
.offer-card:hover{transform:scale(1.03)}
.offer-card img{width:80px;height:60px;object-fit:cover;border-radius:8px;background:white}
.offer-card .hot-badge{position:absolute;top:6px;left:6px;background:orange;color:white;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:600}
.offer-card h3{margin:0;font-size:16px}
.offer-card p{margin:4px 0 0;font-size:13px}
.dots{text-align:center;margin:8px 0}
.dots span{display:inline-block;width:8px;height:8px;border-radius:50%;background:#94a3b8;margin:0 4px}
.dots .active{background:white;width:18px;border-radius:10px}

/* FILTER BAR */
.filter-bar{display:flex;overflow-x:auto;padding:10px 0;background:white;gap:8px}
.filter-bar button{flex-shrink:0;padding:6px 14px;border:none;border-radius:20px;background:#e2e8f0;color:var(--text);font-size:14px;cursor:pointer;transition:.25s}
.filter-bar button.active{background:var(--primary);color:white}

/* SHOP LIST */
.shop-list{padding:12px;display:flex;flex-direction:column;gap:12px}
.shop-item{background:white;border-radius:var(--radius);padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);display:flex;align-items:center;gap:12px;cursor:pointer;transition:.25s;position:relative}
.shop-item:hover{transform:scale(1.02)}
.shop-item img{width:50px;height:50px;border-radius:10px;object-fit:cover;background:#f0f0f0}
.shop-item .info h3{margin:0;font-size:16px}
.shop-item .info p{margin:2px 0;font-size:13px;color:var(--muted)}

/* CARD VIEW */
.card-container{padding:12px;display:none}
.back-btn{display:inline-block;margin-bottom:10px;color:var(--primary);font-weight:600;cursor:pointer}
.card-wrapper{background:white;border-radius:var(--radius);padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.12)}
.profile{display:flex;gap:16px;align-items:center;padding:12px;background:#e2e8f0;border-radius:12px}
.profile img{width:90px;height:90px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)}
.info{font-size:14px}
.info #name{font-weight:700;font-size:18px;margin-top:6px}
.info #business{font-weight:600;margin-bottom:6px}
.actions{display:flex;justify-content:space-around;padding:12px;background:var(--primary);border-radius:12px;margin-top:10px}
.actions a{color:white;font-size:20px}
.ctaBar{margin:10px 0;padding:10px;border-radius:12px;background:linear-gradient(90deg,var(--primary),#0f172a);color:white;font-size:14px;font-weight:600;display:flex;align-items:center;gap:10px;cursor:pointer}
.ctaBar img{width:40px;height:40px;border-radius:8px;object-fit:cover;background:white}
.offers{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;margin-top:10px}
.offer{min-width:90%;margin-right:12px;background:var(--primary);border-radius:12px;padding:10px;scroll-snap-align:center;color:white;display:flex;gap:12px;align-items:center;cursor:pointer;position:relative}
.offer img{max-width:100px;max-height:80px;border-radius:8px;background:white}
.offer .hot-badge{position:absolute;top:6px;left:6px;background:yellow;color:black;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:600}
.offerContent{flex:1}
.offer button{padding:6px 12px;border-radius:20px;border:1px solid white;background:transparent;color:white;font-size:13px;margin-top:6px}

/* Floating Social */
.socialStack{position:fixed;right:14px;bottom:80px;width:46px;height:46px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:20px;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.socialExpand{position:absolute;bottom:56px;right:0;display:none;flex-direction:column;gap:10px}
.socialExpand a{width:40px;height:40px;border-radius:50%;background:#0f172a;color:white;display:flex;align-items:center;justify-content:center;font-size:18px}
</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash">
  <img src="clocktower.png" alt="Clock Tower">
  <h1>Faisalabad Bazar</h1>
  <p>Discover the hottest deals & offers!</p>
  <div style="margin-top:8px;font-size:12px;opacity:0.8;">Developed by FaiqTech</div>
</div>

<div class="header">Faisalabad Bazar</div>

<div class="trending-container" id="trendingContainer"></div>
<div class="carousel-container" id="offersCarousel"></div>
<div class="dots" id="carouselDots"></div>

<div class="filter-bar" id="bazarFilter">
  <button data-bazar="Clock Tower Bazar" class="active">Clock Tower</button>
  <button data-bazar="Katchery Bazar">Katchery</button>
  <button data-bazar="Rail Bazar">Rail</button>
  <button data-bazar="Gol Bazar">Gol</button>
  <button data-bazar="Bhawana Bazaar">Bhawana</button>
  <button data-bazar="Jhang Bazaar">Jhang</button>
  <button data-bazar="Aminpur Bazaar">Aminpur</button>
  <button data-bazar="Kharkhana Bazaar">Kharkhana</button>
  <button data-bazar="Chiniot Bazaar">Chiniot</button>
</div>

<div class="shop-list" id="shopList"></div>

<div class="card-container" id="cardView">
  <div class="back-btn" onclick="backToDirectory()">‚Üê Back to Directory</div>
  <div class="card-wrapper" id="cardWrapper"></div>
</div>

<div class="socialStack" onclick="toggleSocial()">
 <i class="fab fa-facebook-f"></i>
 <div class="socialExpand" id="socialExpand">
  <a id="fb"><i class="fab fa-facebook-f"></i></a>
  <a id="ig"><i class="fab fa-instagram"></i></a>
  <a id="yt"><i class="fab fa-youtube"></i></a>
  <a id="web"><i class="fa fa-globe"></i></a>
 </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// Service Worker
if('serviceWorker' in navigator){ navigator.serviceWorker.register("sw.js",{scope:"./"}); }

// Supabase client
const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

let allCards=[];

// SPLASH
window.addEventListener("load",()=>{
 setTimeout(()=>{
   const splash=document.getElementById("splash");
   splash.style.opacity="0";
   setTimeout(()=>splash.style.display="none",800);
 },2500);
});

// Fetch all cards
db.from("cards").select("*").then(r=>{
 if(r.data){
   allCards = r.data.map(c=>JSON.parse(c.data));
   initOffersCarousel();
   populateTrending();
   populateShopList('Clock Tower Bazar');
 }
});

// Functions
let offerIndex=0;
function initOffersCarousel(){
 const carousel=document.getElementById("offersCarousel");
 const dots=document.getElementById("carouselDots");
 carousel.innerHTML=""; dots.innerHTML="";
 let mixedOffers=[];
 allCards.forEach(card=>{ card.offers.forEach(o=>{o.phone=card.phone;o.name=card.name;o.businessName=card.businessName;o.bazar=card.bazar; mixedOffers.push(o)}) });
 mixedOffers.forEach((o,i)=>{
   const div=document.createElement("div");
   div.className="offer-card";
   div.innerHTML=`${o.image?`<img src="${o.image}" loading="lazy">`:""}<div><h3>${o.title}</h3><p>${o.desc}</p></div><div class="hot-badge">HOT</div>`;
   div.onclick=()=>location.href="https://wa.me/"+o.phone+"?text="+encodeURIComponent(`Hello, I'm interested in your offer:\n${o.title}\n${o.desc}`);
   carousel.appendChild(div);
   const dot=document.createElement("span");
   if(i==0) dot.classList.add("active");
   dots.appendChild(dot);
 });
 setInterval(()=>{
   if(mixedOffers.length===0) return;
   offerIndex=(offerIndex+1)%mixedOffers.length;
   carousel.scrollTo({left:offerIndex*carousel.offsetWidth,behavior:"smooth"});
   document.querySelectorAll("#carouselDots span").forEach((d,i)=>d.classList.toggle("active",i===offerIndex));
 },4000);
 carousel.addEventListener("scroll",()=>{const index=Math.round(carousel.scrollLeft/carousel.offsetWidth);document.querySelectorAll("#carouselDots span").forEach((d,i)=>d.classList.toggle("active",i===index));});
}

function populateTrending(){
 const container=document.getElementById("trendingContainer");
 container.innerHTML="";
 let trending=[];
 allCards.forEach(card=>{ card.offers.forEach(o=>{ o.cardPhone=card.phone;o.cardApp=card.shopAppLink; trending.push(o); }) });
 trending=trending.sort(()=>Math.random()-0.5).slice(0,10);
 trending.forEach(o=>{
   const div=document.createElement("div");
   div.className="trending-card";
   div.innerHTML=`<img src="${o.image||''}" loading="lazy"><h4>${o.title}</h4><div class="hot-badge">HOT</div>`;
   div.onclick=()=>{ if(o.cardApp) location.href=o.cardApp; else location.href="https://wa.me/"+o.cardPhone+"?text="+encodeURIComponent(`Hello, I am interested in your offer: ${o.title}`); };
   container.appendChild(div);
 });
}

document.querySelectorAll("#bazarFilter button").forEach(btn=>{
 btn.addEventListener("click",()=>{
   document.querySelectorAll("#bazarFilter button").forEach(b=>b.classList.remove("active"));
   btn.classList.add("active");
   populateShopList(btn.dataset.bazar);
 });
});

function populateShopList(bazar){
 const list=document.getElementById("shopList");
 list.innerHTML="";
 allCards.filter(c=>c.bazar===bazar).forEach(c=>{
   const div=document.createElement("div");
   div.className="shop-item";
   div.innerHTML=`<img src="${c.profileImage||''}" loading="lazy"><div class="info"><h3>${c.businessName}</h3><p>${c.category||''}</p></div>`;
   div.onclick=()=>openCard(c);
   list.appendChild(div);
 });
}

function openCard(card){
 document.getElementById("shopList").style.display="flex";
 document.getElementById("bazarFilter").style.display="flex";
 document.getElementById("trendingContainer").style.display="flex";
 document.getElementById("offersCarousel").style.display="flex";
 document.getElementById("carouselDots").style.display="block";
}
  function openCard(card){
 document.getElementById("shopList").style.display="none";
 document.getElementById("bazarFilter").style.display="none";
 document.getElementById("trendingContainer").style.display="none";
 document.getElementById("offersCarousel").style.display="none";
 document.getElementById("carouselDots").style.display="none";
 document.getElementById("cardView").style.display="block";

 const wrapper=document.getElementById("cardWrapper");
 wrapper.innerHTML=`
 <div class="profile">
  <img src="${card.profileImage||''}">
  <div class="info">
    <div id="name">${card.name||''}</div>
    <div id="business">${card.businessName||''}</div>
    <div id="phone">üìû ${card.phone||''}</div>
    <div id="email">‚úâÔ∏è ${card.email||''}</div>
    <div id="address">üìç ${card.address||''}</div>
  </div>
 </div>
 <div class="about">${card.businessInfo||''}</div>
 ${card.shopAppLink?`<div class="ctaBar" onclick="location.href='${card.shopAppLink}'">${card.shopAppImage?`<img src='${card.shopAppImage}' loading="lazy">`:""}<div>Shop on our official app</div></div>`:""}
 <div class="offers">${card.offers.map(o=>`<div class="offer" onclick="location.href='https://wa.me/${card.phone}?text=${encodeURIComponent(`Hello, I am interested in your offer: ${o.title} ${o.desc}`)}'">${o.image?`<img src='${o.image}' loading="lazy'>`:""}<div class="offerContent"><h3>üî• ${o.title}</h3><p>${o.desc}</p><button>Get Offer</button></div><div class="hot-badge">HOT</div></div>`).join('')}</div>
 <div class="actions">
  <a href="tel:${card.phone}"><i class="fa fa-phone"></i></a>
  <a href="https://wa.me/${card.phone}"><i class="fab fa-whatsapp"></i></a>
  <a href="mailto:${card.email}"><i class="fa fa-envelope"></i></a>
  <a href="https://maps.google.com/?q=${encodeURIComponent(card.address)}"><i class="fa-solid fa-location-dot"></i></a>
 </div>`;
}

function backToDirectory(){
 document.getElementById("cardView").style.display="none";
 document.getElementById("shopList").style.display="flex";
 document.getElementById("bazarFilter").style.display="flex";
 document.getElementById("trendingContainer").style.display="flex";
 document.getElementById("offersCarousel").style.display="flex";
 document.getElementById("carouselDots").style.display="block";
}

/* SOCIAL TOGGLE */
function toggleSocial(){
 const s=document.getElementById("socialExpand");
 s.style.display = (s.style.display==="flex") ? "none" : "flex";
}

/* IMAGE AUTO COMPRESS (for future use) */
function compressImage(file,max=512,quality=0.75){
 return new Promise(res=>{
  const img=new Image();
  img.onload=()=>{
   let w=img.width,h=img.height;
   const r=Math.min(max/w,max/h,1);
   w*=r; h*=r;
   const c=document.createElement("canvas");
   c.width=w; c.height=h;
   c.getContext("2d").drawImage(img,0,0,w,h);
   res(c.toDataURL("image/jpeg",quality));
  };
  img.src=URL.createObjectURL(file);
 });
}

/* SHARE APP */
if(navigator.share){
 document.querySelector(".header").addEventListener("click",()=>{
  navigator.share({
   title:"Faisalabad Bazar",
   text:"Explore deals & shops in Faisalabad",
   url:location.href
  });
 });
}

/* HISTORY CONTROL (PWA feel) */
history.pushState({}, "");
window.addEventListener("popstate",()=>{
 if(document.getElementById("cardView").style.display==="block"){
  backToDirectory();
 }else{
  window.close();
 }
});
</script>
</body>
</html>
