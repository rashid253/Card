<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;color:#0f172a}
.profile{display:flex;gap:16px;padding:16px;background:#e2e8f0;position:relative}
.profile img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid #2563eb;background:#fff}
.info{flex:1;display:flex;flex-direction:column;gap:4px}
#name{font-size:17px;font-weight:700}
#business{font-weight:600}
#phone,#email,#address{font-size:14px;opacity:.85}
.about{background:#fff;padding:14px 16px;cursor:pointer}
.aboutText{overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
.about.expanded .aboutText{-webkit-line-clamp:unset}
.aboutMore{color:#2563eb;font-weight:600;margin-top:6px;display:inline-block}
.offers{display:flex;gap:12px;padding:12px;overflow-x:auto}
.offer{min-width:160px;height:200px;border-radius:16px;background:#fff;position:relative;cursor:pointer}
.offer img{width:100%;height:100%;object-fit:contain}
.offerBadges{position:absolute;top:10px;left:10px;display:flex;flex-direction:column;gap:6px}
.offerBadges span{background:#ef4444;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:8px}
#offerPanel{position:fixed;inset:0;background:#fff;z-index:999;display:none}
#offerPanel img{width:100%;max-height:280px;object-fit:contain}
.panelContent{padding:16px}
.panelCTA{margin-top:16px;background:#16a34a;color:#fff;padding:16px;text-align:center;border-radius:12px;font-weight:700;cursor:pointer}
</style>
</head>

<body>

<div class="profile">
 <img id="photo">
 <div class="info">
  <div id="name"></div>
  <div id="business"></div>
  <div id="phone"></div>
  <div id="email"></div>
  <div id="address"></div>
 </div>
</div>

<div class="about" id="aboutBox" onclick="toggleAbout()">
 <div class="aboutText" id="aboutText"></div>
 <span class="aboutMore" id="aboutMore">See more</span>
</div>

<div class="offers" id="offers"></div>

<div id="offerPanel">
 <img id="panelImg">
 <div class="panelContent">
  <h2 id="panelTitle"></h2>
  <p id="panelDesc"></p>
  <div class="panelCTA" id="panelCTA">WhatsApp</div>
 </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
document.addEventListener("DOMContentLoaded", async ()=>{
const $=id=>document.getElementById(id);

const photo=$("photo"), nameEl=$("name"), businessEl=$("business"),
phoneEl=$("phone"), emailEl=$("email"), addressEl=$("address"),
aboutText=$("aboutText"), aboutMore=$("aboutMore"), aboutBox=$("aboutBox"),
offers=$("offers"), panelImg=$("panelImg"), panelTitle=$("panelTitle"),
panelDesc=$("panelDesc"), panelCTA=$("panelCTA"), offerPanel=$("offerPanel");

const supa = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

const id = new URLSearchParams(location.search).get("id") || localStorage.getItem("lastCardId");
if(!id){document.body.innerHTML="<h2>No card found</h2>";return;}

const {data,error}=await supa.from("cards").select("*").eq("id",id).single();
if(error || !data){document.body.innerHTML="<h2>Card not found</h2>";return;}

const card = JSON.parse(data.data);

photo.src = card.profileImage || "";
nameEl.textContent = card.name || "";
businessEl.textContent = card.businessName || "";
phoneEl.textContent = "ðŸ“ž " + (card.phone||"");
emailEl.textContent = "âœ‰ï¸ " + (card.email||"");
addressEl.textContent = "ðŸ“ " + (card.address||"");
aboutText.textContent = card.business?.about || "";

// OFFERS
offers.innerHTML="";
(card.offers||[]).forEach(o=>{
 const d = document.createElement("div");
 d.className="offer";
 d.innerHTML=`<img src="${o.image}">
 <div class="offerBadges">${(o.badges||[]).map(b=>`<span>${b}</span>`).join("")}</div>`;
 d.onclick=()=>{
   panelImg.src=o.image;
   panelTitle.textContent=o.title;
   panelDesc.textContent=o.desc;
   panelCTA.onclick=()=>location.href=`https://wa.me/${card.phone.replace(/\D/g,"")}`;
   offerPanel.style.display="block";
 };
 offers.appendChild(d);
});

// ABOUT TOGGLE
window.toggleAbout=()=>{
 aboutBox.classList.toggle("expanded");
 aboutMore.textContent=aboutBox.classList.contains("expanded")?"See less":"See more";
};
});
</script>
</body>
</html>
