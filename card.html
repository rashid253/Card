<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{--fs:15.5px;--lh:1.75}
body{
 margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
 font-size:var(--fs);line-height:var(--lh);
 background:#f1f5f9;color:#0f172a
}

/* TOP BAR */
.topbar{display:flex;justify-content:space-around;padding:12px;background:#0f172a}
.topbar a{color:#fff;font-size:20px}

/* PROFILE */
.profile{
 display:flex;gap:16px;padding:16px;background:#e2e8f0;
 align-items:flex-start;position:relative
}
.profile img{
 width:110px;height:110px;border-radius:50%;
 object-fit:cover;border:3px solid #2563eb;background:#fff
}
.info{flex:1;display:flex;flex-direction:column;gap:4px}
#name{font-size:17px;font-weight:700}
#business{font-weight:600}
#phone,#email,#address{font-size:14px;opacity:.85}

/* SAVE */
.saveIcon{
 position:absolute;right:14px;bottom:14px;
 font-size:22px;color:#2563eb;cursor:pointer
}

/* ABOUT */
.about{background:#fff;padding:14px 16px;cursor:pointer}
.aboutText{
 overflow:hidden;display:-webkit-box;
 -webkit-line-clamp:3;-webkit-box-orient:vertical
}
.about.expanded .aboutText{-webkit-line-clamp:unset}
.aboutMore{color:#2563eb;font-weight:600;margin-top:6px;display:inline-block}

/* BUSINESS */
.businessBox{background:#fff;margin:12px;padding:14px;border-radius:14px}
.businessBox h3{margin:0 0 10px;font-size:16px}
.hoursRow{
 display:flex;justify-content:space-between;
 padding:6px 0;border-bottom:1px dashed #e5e7eb
}
.hoursRow:last-child{border-bottom:none}
.open{color:#16a34a;font-weight:600}
.closed{color:#dc2626;font-weight:600}

/* OFFERS */
.offers{display:flex;overflow-x:auto;scroll-snap-type:x mandatory}
.offer{
 min-width:90%;margin:12px;background:#2563eb;
 border-radius:18px;padding:14px;color:#fff;
 display:flex;gap:14px;scroll-snap-align:center;
 position:relative
}
.offer img{
 max-width:120px;max-height:100px;
 object-fit:contain;background:#fff;border-radius:10px
}
.offerContent{flex:1}
.offerContent h3{margin:0 0 6px}

/* LIMITED TIME BADGE */
.limitedBadge{
 display:inline-block;
 background:#facc15;
 color:#000;
 font-size:12px;
 font-weight:700;
 padding:4px 8px;
 border-radius:999px;
 margin-bottom:6px
}

/* OFFER BUTTON */
.offerBtn{
 display:inline-block;
 margin-top:10px;
 background:#fff;
 color:#2563eb;
 padding:10px 16px;
 border-radius:999px;
 font-weight:700;
 cursor:pointer;
 width:auto;
 transition:.2s ease;
}
.offerBtn:hover{
 background:#2563eb;
 color:#fff;
}

/* DOTS */
.dots{text-align:center;margin-bottom:12px}
.dots span{
 display:inline-block;width:8px;height:8px;
 border-radius:50%;background:#94a3b8;margin:0 4px
}
.dots .active{background:#2563eb;width:18px;border-radius:10px}

/* ACTIONS */
.actions{display:flex;justify-content:space-around;padding:16px;background:#0f172a}
.actions a{color:#fff;font-size:22px}
</style>
</head>

<body>

<div class="topbar">
 <a id="share"><i class="fa fa-share"></i></a>
 <a id="map"><i class="fa-solid fa-location-dot"></i></a>
 <a id="sms"><i class="fa fa-comment"></i></a>
</div>

<div class="profile">
 <img id="photo">
 <div class="info">
  <div id="name"></div>
  <div id="business"></div>
  <div id="phone"></div>
  <div id="email"></div>
  <div id="address"></div>
 </div>
 <i class="fa fa-floppy-disk saveIcon" onclick="saveCard()"></i>
</div>

<div class="about" id="aboutBox" onclick="toggleAbout()">
 <div class="aboutText" id="aboutText"></div>
 <span class="aboutMore" id="aboutMore">See more</span>
</div>

<div class="offers" id="offers"></div>
<div class="dots" id="dots"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const db=supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

let id=new URLSearchParams(location.search).get("id")
 || localStorage.getItem("lastCardId");
if(!id){document.body.innerHTML="<h2>No card found</h2>";throw"";}

let sellerPhone="";

db.from("cards").select("*").eq("id",id).single().then(r=>{
 if(r.data) loadCard(JSON.parse(r.data.data));
});

function isLimited(text){
 return /(limited|today|only|last|24|hrs|hours|time)/i.test(text);
}

function loadCard(data){
 sellerPhone=(data.phone||"").replace(/\D/g,"");

 photo.src=data.profileImage||"";
 name.textContent=data.name||"";
 business.textContent=data.businessName||"";
 phone.textContent="üìû "+(data.phone||"");
 email.textContent="‚úâÔ∏è "+(data.email||"");
 address.textContent="üìç "+(data.address||"");

 offers.innerHTML="";dots.innerHTML="";
 data.offers?.forEach((o,i)=>{
  const limited = isLimited(o.title+" "+o.desc);

  const msg=
`Hello, I‚Äôm interested in this offer:

üî• ${o.title}

Please share complete product details, price & availability.

Card link:
${location.href}`;

  const waLink=`https://wa.me/${sellerPhone}?text=${encodeURIComponent(msg)}`;

  const d=document.createElement("div");
  d.className="offer";
  d.innerHTML=`
   ${o.image?`<img src="${o.image}">`:""}
   <div class="offerContent">
    ${limited?`<div class="limitedBadge">‚è∞ Limited Time Offer</div>`:""}
    <h3>üî• ${o.title}</h3>
    <p>${o.desc}</p>
    <div class="offerBtn" onclick="window.open('${waLink}','_blank')">
     Grab Offer
    </div>
   </div>`;
  offers.appendChild(d);

  const dot=document.createElement("span");
  if(i===0)dot.classList.add("active");
  dots.appendChild(dot);
 });
}

function toggleAbout(){
 aboutBox.classList.toggle("expanded");
 aboutMore.textContent=
  aboutBox.classList.contains("expanded")?"See less":"See more";
}

function saveCard(){
 const vcf=`BEGIN:VCARD
VERSION:3.0
FN:${name.textContent}
TEL:${phone.textContent.replace("üìû ","")}
END:VCARD`;
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([vcf],{type:"text/vcard"}));
 a.download="contact.vcf";a.click();
}
</script>
</body>
</html>
