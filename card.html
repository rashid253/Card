<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{--fs:15.5px;--lh:1.75}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:var(--fs);line-height:var(--lh);background:#f1f5f9;color:#0f172a;padding-bottom:140px;}

/* PROFILE */
.profile{display:flex;gap:16px;padding:16px;background:#e2e8f0;align-items:flex-start;position:relative;}
.profile img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid #2563eb;background:#fff;}
.info{flex:1;display:flex;flex-direction:column;gap:4px}
#name{font-size:17px;font-weight:700}
#business{font-weight:600}
#phone,#email,#address{font-size:14px;opacity:.85}
.saveIcon{position:absolute;right:14px;bottom:14px;font-size:22px;color:#2563eb;cursor:pointer}

/* CTA / BADGES */
.ctaBar{margin:12px;padding:8px 12px;border-radius:14px;background:linear-gradient(90deg,#2563eb,#0f172a);color:#fff;font-weight:600;display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;}
.ctaBadge{background:#dc2626;color:#fff;padding:4px 10px;border-radius:12px;font-weight:700;font-size:13px;}
.countdown{background:#16a34a;color:#fff;padding:4px 10px;border-radius:12px;font-weight:700;font-size:13px;}

/* BUSINESS HOURS */
.hoursBox{background:#fff;padding:12px;margin:12px;border-radius:14px;}
.hoursRow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #e5e7eb;}
.hoursRow:last-child{border-bottom:none;}
.open{color:#16a34a;font-weight:600;}
.closed{color:#dc2626;font-weight:600;}

/* SOCIAL MEDIA ROW */
.socialRow{display:flex;gap:12px;margin:12px;}
.socialRow a{width:42px;height:42px;background:#2563eb;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;text-decoration:none;}

/* OFFERS */
.offers{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;gap:12px;padding:12px}
.offer{flex:0 0 80%;background:#fff;border-radius:18px;overflow:hidden;scroll-snap-align:center;box-shadow:0 6px 18px rgba(0,0,0,.12);position:relative;}
.offer img{width:100%;height:180px;object-fit:cover;display:block;background:#e5e7eb;}
.offerContent{padding:14px;}
.offerContent h3{margin:0 0 6px;font-size:16px;}
.offerShort{opacity:.75;font-size:14px;}
.offerBtn{margin-top:12px;background:#2563eb;color:#fff;padding:12px;border-radius:10px;font-weight:700;text-align:center;cursor:pointer;}

/* MODAL */
.modalBg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:99;}
.modal{background:#fff;width:90%;max-width:400px;border-radius:16px;overflow:hidden;animation:fadeIn 0.3s;}
.modalHeader{padding:14px;background:#2563eb;color:#fff;font-weight:700;font-size:16px;position:relative;}
.modalContent{padding:14px;max-height:60vh;overflow-y:auto;}
.modalClose{position:absolute;right:14px;top:14px;color:#fff;font-size:20px;cursor:pointer;}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}

/* ACTIONS */
.actions{display:flex;justify-content:space-around;padding:16px;background:#0f172a;position:fixed;bottom:0;left:0;right:0}
.actions a{color:#fff;font-size:22px}
</style>
</head>

<body>

<!-- PROFILE -->
<div class="profile">
 <img id="photo">
 <div class="info">
  <div id="name"></div>
  <div id="business"></div>
  <div id="phone"></div>
  <div id="email"></div>
  <div id="address"></div>
 </div>
 <i class="fa fa-floppy-disk saveIcon" onclick="saveCard()"></i>
</div>

<!-- CTA / BADGES -->
<div id="ctaContainer" class="ctaBar"></div>

<!-- BUSINESS HOURS -->
<div class="hoursBox" id="hoursBox"></div>

<!-- SOCIAL MEDIA -->
<div class="socialRow" id="socialRow"></div>

<!-- OFFERS / CARDS -->
<div class="offers" id="offers"></div>

<!-- MODAL -->
<div class="modalBg" id="modalBg">
 <div class="modal">
  <div class="modalHeader">Offer Details <span class="modalClose" onclick="closeModal()">&times;</span></div>
  <div class="modalContent" id="modalContent"></div>
 </div>
</div>

<!-- ACTIONS -->
<div class="actions">
 <a id="call"><i class="fa fa-phone"></i></a>
 <a id="wa"><i class="fab fa-whatsapp"></i></a>
 <a id="mail"><i class="fa fa-envelope"></i></a>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
function compressImage(src,cb){
 const img=new Image(); img.crossOrigin="anonymous";
 img.onload=()=>{ const c=document.createElement("canvas"); const max=900; const ratio=Math.min(max/img.width,1); c.width=img.width*ratio;c.height=img.height*ratio; c.getContext("2d").drawImage(img,0,0,c.width,c.height); cb(c.toDataURL("image/jpeg",0.7)); };
 img.src=src;
}

const db=supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

let id=new URLSearchParams(location.search).get("id")||localStorage.getItem("lastCardId");
if(!id){document.body.innerHTML="<h2>No card found</h2>";throw"";}

let sellerPhone="";
db.from("cards").select("*").eq("id",id).single().then(r=>{ if(r.data) loadCard(JSON.parse(r.data.data)); });

function loadCard(data){
 sellerPhone=(data.phone||"").replace(/\D/g,"");
 compressImage(data.profileImage||"",i=>photo.src=i);

 name.textContent=data.name||"";
 business.textContent=data.businessName||"";
 phone.textContent="ðŸ“ž "+(data.phone||"");
 email.textContent="âœ‰ï¸ "+(data.email||"");
 address.textContent="ðŸ“ "+(data.address||"");

 call.href="tel:"+data.phone;
 wa.href="https://wa.me/"+sellerPhone;
 mail.href="mailto:"+data.email;

 // CTA / BADGES
 ctaContainer.innerHTML="";
 if(data.ctaBadges?.length){
   data.ctaBadges.forEach(b=>{
     const span=document.createElement("span");
     span.className=b.type==="countdown"?"countdown":"ctaBadge";
     span.textContent=b.text;
     ctaContainer.appendChild(span);
   });
 }

 // BUSINESS HOURS
 hoursBox.innerHTML="";
 if(data.business?.hours){
   hoursBox.innerHTML="<h3>Business Hours</h3>";
   Object.keys(data.business.hours).forEach(d=>{
     const h=data.business.hours[d];
     hoursBox.innerHTML+=`<div class="hoursRow"><span>${d}</span><span class="${h.open?'open':'closed'}">${h.open?`${h.from} â€“ ${h.to}`:"Closed"}</span></div>`;
   });
 }

 // SOCIAL MEDIA
 socialRow.innerHTML="";
 [["fb",data.facebook,"fab fa-facebook-f"],["ig",data.instagram,"fab fa-instagram"],["yt",data.youtube,"fab fa-youtube"],["web",data.website,"fa fa-globe"]].forEach(([id,url,icon])=>{
   if(url){ const a=document.createElement("a"); a.href=url; a.target="_blank"; a.innerHTML=`<i class="${icon}"></i>`; socialRow.appendChild(a); }
 });

 // OFFERS
 offers.innerHTML="";
 data.offers?.forEach(o=>{
  const d=document.createElement("div"); d.className="offer";
  d.innerHTML=`<img><div class="offerContent"><h3>${o.title}</h3><div class="offerShort">${o.desc.slice(0,60)}...</div><div class="offerBtn" onclick="openModal('${o.title}','${o.desc}','${sellerPhone}')">Get Offer</div></div>`;
  offers.appendChild(d);
  if(o.image) compressImage(o.image,i=>d.querySelector("img").src=i);
 });
}

// MODAL
function openModal(title,desc,phone){
 modalBg.style.display="flex";
 modalContent.innerHTML=`<p><b>${title}</b></p><p>${desc}</p><div class="offerBtn" onclick="window.open('https://wa.me/${phone}?text=${encodeURIComponent('Hello, I am interested in '+title)}','_blank')">Get on WhatsApp</div>`;
}
function closeModal(){modalBg.style.display="none";}

// SAVE
function saveCard(){
 const vcf=`BEGIN:VCARD\nVERSION:3.0\nFN:${name.textContent}\nTEL:${phone.textContent.replace("ðŸ“ž ","")}\nEND:VCARD`;
 const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([vcf],{type:"text/vcard"})); a.download="contact.vcf"; a.click();
}
</script>
</body>
</html>
