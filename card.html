<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
<div class="card">

<div class="top">
 <div onclick="saveContact()"><i class="fa fa-user-plus"></i></div>
 <div id="callBtn"><i class="fa fa-phone"></i></div>
 <div id="waBtn"><i class="fab fa-whatsapp"></i></div>
</div>

<h2 id="name"></h2>
<p id="phone"></p>
<p id="email"></p>
<p id="address"></p>

<div class="social">
 <a id="fb"><i class="fab fa-facebook"></i></a>
 <a id="ig"><i class="fab fa-instagram"></i></a>
 <a id="yt"><i class="fab fa-youtube"></i></a>
</div>

<h3>Offers</h3>
<div id="offerList"></div>

</div>

<script>
const SUPABASE_URL="https://dfvnefbxgayxqgjjgtrr.supabase.co";
const SUPABASE_KEY="sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE";

const id=new URLSearchParams(location.search).get("id");

fetch(SUPABASE_URL+"/rest/v1/cards?id=eq."+id,{
 headers:{apikey:SUPABASE_KEY}
})
.then(r=>r.json())
.then(res=>{
 const data=JSON.parse(res[0].data);

 name.textContent=data.name;
 phone.textContent=data.phone;
 email.textContent=data.email;
 address.textContent=data.address;

 callBtn.onclick=()=>location.href="tel:"+data.phone;
 waBtn.onclick=()=>location.href="https://wa.me/"+data.phone;

 if(data.facebook) fb.href=data.facebook; else fb.style.display="none";
 if(data.instagram) ig.href=data.instagram; else ig.style.display="none";
 if(data.youtube) yt.href=data.youtube; else yt.style.display="none";

 data.offers.forEach(o=>{
  const d=document.createElement("div");
  d.className="offer";
  d.innerHTML=`
   <b>${o.title}</b>
   <p>${o.desc}</p>
   <div class="offerActions">
    <a class="offerCall"><i class="fa fa-phone"></i></a>
    <a class="offerWa"><i class="fab fa-whatsapp"></i></a>
    <a class="offerMail"><i class="fa fa-envelope"></i></a>
   </div>
  `;
  d.querySelector(".offerCall").href="tel:"+data.phone;
  d.querySelector(".offerWa").href=
   "https://wa.me/"+data.phone+
   "?text="+encodeURIComponent(o.title+"\n"+o.desc);
  d.querySelector(".offerMail").href="mailto:"+data.email;
  offerList.appendChild(d);
 });
});

function saveContact(){
 const vcard=`BEGIN:VCARD
VERSION:3.0
FN:${name.textContent}
TEL:${phone.textContent}
EMAIL:${email.textContent}
ADR:${address.textContent}
END:VCARD`;
 const blob=new Blob([vcard],{type:"text/vcard"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="contact.vcf";
 a.click();
}
</script>
</body>
</html>
