<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Digital Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{--fs:15.5px;--lh:1.75}
*{box-sizing:border-box}
body{
 margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
 font-size:var(--fs);line-height:var(--lh);background:#f1f5f9;
 color:#0f172a;padding-bottom:160px;
}

/* TOP CTA & BADGES */
.topCTA{
 background:#2563eb;color:#fff;text-align:center;padding:12px;border-radius:12px;margin:12px;
 font-weight:600;font-size:16px;position:relative;
}
.badge{
 display:inline-block;background:#dc2626;color:#fff;padding:4px 8px;border-radius:8px;
 font-size:13px;margin:0 4px;font-weight:700;
}
.countdown{display:block;font-size:14px;margin-top:6px;color:#fff}

/* PROFILE */
.profile{display:flex;gap:16px;padding:16px;background:#e2e8f0;align-items:flex-start;position:relative}
.profile img{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid #2563eb;background:#fff}
.info{flex:1;display:flex;flex-direction:column;gap:4px}
#name{font-size:17px;font-weight:700}
#business{font-weight:600}
#phone,#email,#address{font-size:14px;opacity:.85}

/* ABOUT */
.about{background:#fff;padding:14px 16px;cursor:pointer;margin:12px 0}
.aboutText{overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
.about.expanded .aboutText{-webkit-line-clamp:unset}
.aboutMore{color:#2563eb;font-weight:600;margin-top:6px;display:inline-block}

/* OFFERS */
.offers{display:flex;flex-direction:column;gap:14px;margin:12px}
.offer{
 background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.12);cursor:pointer
}
.offer img{width:100%;height:180px;object-fit:cover;background:#e5e7eb;display:block}
.offerContent{padding:12px}
.offerContent h3{margin:0 0 6px;font-size:16px}
.offerBtn{margin-top:10px;background:#2563eb;color:#fff;padding:10px;border-radius:10px;text-align:center;font-weight:700;cursor:pointer}

/* MODAL */
.modalOverlay{
 display:none;position:fixed;top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,.6);align-items:center;justify-content:center;
 z-index:9999
}
.modal{
 background:#fff;padding:16px;border-radius:12px;max-width:360px;width:90%;
 text-align:center;position:relative
}
.modalClose{
 position:absolute;top:8px;right:8px;font-size:18px;cursor:pointer;color:#2563eb
}

/* ACTIONS */
.actions{display:flex;justify-content:space-around;padding:16px;background:#0f172a;position:fixed;bottom:0;left:0;right:0}
.actions a{color:#fff;font-size:22px}
</style>
</head>

<body>

<!-- TOP CTA -->
<div class="topCTA" id="topCTA">
 <span id="ctaText"></span>
 <span class="badge" id="badge1"></span>
 <span class="badge" id="badge2"></span>
 <span class="countdown" id="countdown"></span>
</div>

<!-- PROFILE -->
<div class="profile">
 <img id="photo">
 <div class="info">
  <div id="name"></div>
  <div id="business"></div>
  <div id="phone"></div>
  <div id="email"></div>
  <div id="address"></div>
 </div>
</div>

<div class="about" id="aboutBox" onclick="toggleAbout()">
 <div class="aboutText" id="aboutText"></div>
 <span class="aboutMore" id="aboutMore">See more</span>
</div>

<div class="offers" id="offers"></div>

<div class="actions">
 <a id="call"><i class="fa fa-phone"></i></a>
 <a id="wa"><i class="fab fa-whatsapp"></i></a>
 <a id="mail"><i class="fa fa-envelope"></i></a>
</div>

<!-- OFFER MODAL -->
<div class="modalOverlay" id="modalOverlay">
 <div class="modal">
  <span class="modalClose" onclick="closeModal()">√ó</span>
  <h3 id="modalTitle"></h3>
  <p id="modalDesc"></p>
  <div class="offerBtn" id="modalWA">Contact on WhatsApp</div>
 </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

let id = new URLSearchParams(location.search).get("id") || localStorage.getItem("lastCardId");
if(!id){document.body.innerHTML="<h2>No card found</h2>";throw"";}

let sellerPhone="";
db.from("cards").select("*").eq("id",id).single().then(r=>{
 if(r.data) loadCard(JSON.parse(r.data.data));
});

/* IMAGE COMPRESS */
function compressImage(src,cb){
 const img=new Image();
 img.crossOrigin="anonymous";
 img.onload=()=>{
  const c=document.createElement("canvas");
  const max=900;
  const s=Math.min(1,max/img.width);
  c.width=img.width*s;c.height=img.height*s;
  c.getContext("2d").drawImage(img,0,0,c.width,c.height);
  cb(c.toDataURL("image/jpeg",0.7));
 };
 img.src=src;
}

/* LOAD CARD */
function loadCard(data){
 sellerPhone = (data.phone||"").replace(/\D/g,"");

 if(data.profileImage) compressImage(data.profileImage,i=>photo.src=i);

 name.textContent=data.name||"";
 business.textContent=data.businessName||"";
 phone.textContent="üìû "+(data.phone||"");
 email.textContent="‚úâÔ∏è "+(data.email||"");
 address.textContent="üìç "+(data.address||"");

 call.href="tel:"+data.phone;
 wa.href="https://wa.me/"+sellerPhone;
 mail.href="mailto:"+data.email;

 aboutText.textContent = data.business?.about||"";
 if(aboutText.textContent.length<120) aboutMore.style.display="none";

 /* TOP CTA & BADGES */
 ctaText.textContent = data.topCTAText || "";
 badge1.textContent = data.badges?.[0] || "";
 badge2.textContent = data.badges?.[1] || "";
 countdown.textContent = data.countdown || "";

 /* OFFERS */
 offers.innerHTML="";
 data.offers?.forEach(o=>{
  const div=document.createElement("div");
  div.className="offer";
  div.innerHTML=`
   ${o.image?`<img src="${o.image}">`:''}
   <div class="offerContent">
    <h3>${o.title}</h3>
    <div class="offerBtn" onclick="openModal('${o.title}','${o.desc}','${sellerPhone}')">Get Offer</div>
   </div>`;
  offers.appendChild(div);
 });
}

/* ABOUT TOGGLE */
function toggleAbout(){
 aboutBox.classList.toggle("expanded");
 aboutMore.textContent=aboutBox.classList.contains("expanded")?"See less":"See more";
}

/* MODAL FUNCTIONS */
function openModal(title,desc,phone){
 document.getElementById("modalTitle").textContent = title;
 document.getElementById("modalDesc").textContent = desc;
 document.getElementById("modalWA").onclick = ()=>window.open(`https://wa.me/${phone}?text=${encodeURIComponent(title + " - " + desc)}`,'_blank');
 document.getElementById("modalOverlay").style.display="flex";
}
function closeModal(){document.getElementById("modalOverlay").style.display="none";}

/* COUNTDOWN DYNAMIC (if needed) */
if(countdown.textContent){
 setInterval(()=>{
   let parts = countdown.textContent.match(/(\d+)/g);
   if(parts && parts.length>=2){
     let hours = parseInt(parts[0]), minutes = parseInt(parts[1]);
     if(minutes>0) minutes--;
     else if(hours>0){ hours--; minutes=59; } 
     countdown.textContent = `Ends in ${hours}h ${minutes}m`;
   }
 },60000);
}
</script>
</body>
</html>
